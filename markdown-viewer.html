<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>xut | Apuntes</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="site-header-inner">
      <a class="site-brand" href="/" aria-label="xut - inicio">
        <span aria-hidden="true">✱</span>
        <span>xut</span>
      </a>

      <nav class="site-nav" aria-label="Principal">
        <ul>
          <li><a href="/">Inicio</a></li>
          <li><a href="/#indice">Apuntes</a></li>
          <li><a href="/sobre-mi.html">Sobre mí</a></li>
          <li><a href="https://github.com/xut-e" rel="noopener" target="_blank">GitHub</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- LAYOUT -->
  <main class="page-shell">
  <!-- SIDEBAR DINÁMICO IGUAL QUE EN INDEX -->
  <aside class="sidebar" id="indice">
    <h2 id="indice-label">Índice</h2>
    <div id="dynamic-index">
      <p>Cargando índice...</p>
    </div>
  </aside>

  <!-- CONTENIDO MARKDOWN -->
  <section class="markdown-body">
    <h1 id="md-title">Cargando…</h1>
    <div id="md-content" style="font-size:.95rem; line-height:1.5;">
      Cargando contenido del apunte…
    </div>
  </section>
</main>


  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="site-footer-inner">
      <small>© <span id="year"></span> xut-e — Todos los derechos reservados</small>
      <pre class="ascii" aria-hidden="true">
             ..                      .....          
   .H88x.  :~)88:                 .H8888888h.  ~-.  
  x888888X ~:8888    x.    .      888888888888x  `> 
 ~   "8888X  %88"  .@88k  z88u   X~     `?888888hx~ 
      X8888       ~"8888 ^8888   '      x8.^"*88*"  
   .xxX8888xxxd>    8888  888R    `-:- X8888x       
  :88888888888"     8888  888R         488888>      
  ~   '8888         8888  888R       .. `"88*       
 xx.  X8888:    .   8888 ,888B .   x88888nX"      . 
X888  X88888x.x"   "8888Y 8888"   !"*8888888n..  :  
X88% : '%8888"      `Y"   'YP    '    "*88888888*   
 "*=~    `""                             ^"***"`    
      </pre>
    </div>
  </footer>

  <!-- SCRIPT PRINCIPAL -->
  <script>
	(async function () {
	  const params = new URLSearchParams(window.location.search);
	  const fileParam = params.get("file");

	  const titleEl = document.getElementById("md-title");
	  const contentEl = document.getElementById("md-content");

	  if (!fileParam) {
	    titleEl.textContent = "Sin archivo";
	    contentEl.textContent = "No se ha especificado ningún archivo.";
	    return;
	  }

	  // ruta real en el servidor
	  const realPath = fileParam.startsWith("content/")
	    ? fileParam
	    : "content/" + fileParam;

	  const lower = realPath.toLowerCase();

	  // Si es PDF -> incrustar visor PDF
	  if (lower.endsWith(".pdf")) {
	    // título: nombre del archivo sin .pdf
	    const cleanName = realPath.split("/").pop().replace(/\.pdf$/i, "");
	    titleEl.textContent = cleanName;

	    // Limpiamos contenedor y metemos iframe/embed
	    contentEl.innerHTML = "";

	    const viewer = document.createElement("iframe");
	    viewer.src = realPath;
	    viewer.style.width = "100%";
	    viewer.style.height = "80vh";
	    viewer.style.border = "1px solid var(--border-color, #444)";
	    viewer.loading = "lazy";

	    contentEl.appendChild(viewer);
	    return;
	  }

	  // Si es Markdown -> fetch + render
	  if (lower.endsWith(".md")) {
	    try {
	      const res = await fetch(realPath);
	      if (!res.ok) throw new Error("No se pudo cargar el archivo");
	      let mdText = await res.text();

	      // título = primera línea tipo "# ..." o sino nombre de archivo
	      const lines = mdText.split("\n");
	      const h1Match = lines[0]?.match(/^#\s+(.+)/);
	      if (h1Match) {
		titleEl.textContent = h1Match[1].trim();
	      } else {
		titleEl.textContent = realPath.split("/").pop().replace(/\.md$/i, "");
	      }

	      // Conversión sencilla Markdown->HTML (tu parser / reemplazos existentes)
	      // Aquí asumo que ya tenías un mini parser con <h1>, <h2>, <code>, listas, etc.
	      // Conservo la lógica básica que venías usando:

	      // headers
	      mdText = mdText.replace(/^######\s(.+)$/gm, "<h6>$1</h6>");
	      mdText = mdText.replace(/^#####\s(.+)$/gm, "<h5>$1</h5>");
	      mdText = mdText.replace(/^####\s(.+)$/gm, "<h4>$1</h4>");
	      mdText = mdText.replace(/^###\s(.+)$/gm, "<h3>$1</h3>");
	      mdText = mdText.replace(/^##\s(.+)$/gm, "<h2>$1</h2>");
	      mdText = mdText.replace(/^#\s(.+)$/gm, "<h1>$1</h1>");
	      
	      // horizontal rule (3 o más guiones consecutivos)
	      mdText = mdText.replace(/^-{3,}\s*$/gm, "<hr>");

	      // code inline `...`
	      mdText = mdText.replace(/`+\s*([^`]+?)\s*`+/g, "<code>$1</code>");

	      // bold **...**
	      mdText = mdText.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

	      // italic *...*
	      mdText = mdText.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, "<em>$1</em>");

	      // listas ordenadas
	      mdText = mdText.replace(/^\s*\d+\.\s.+$/gm, m => {
		return "<li>" + m.replace(/^\s*\d+\.\s/, "") + "</li>";
	      });
	      // agrupar <li> consecutivos en <ol>
	      mdText = mdText.replace(/(<li>[\s\S]*?<\/li>)/g, "<ol>$1</ol>")
			     .replace(/<\/ol>\s*<ol>/g, "");

	      // listas sin ordenar
	      mdText = mdText.replace(/^\s*[-+*]\s.+$/gm, m => {
		return "<li>" + m.replace(/^\s*[-+*]\s/, "") + "</li>";
	      });
	      mdText = mdText.replace(/(<li>[\s\S]*?<\/li>)/g, "<ul>$1</ul>")
			     .replace(/<\/ul>\s*<ul>/g, "");

	      // párrafos: líneas normales que no son tags ya
	      mdText = mdText.replace(/^(?!<h\d>|<ul>|<ol>|<li>|<\/li>|<code>|<strong>|<em>|<iframe|<pre|<blockquote)(.+)$/gm,
		"<p>$1</p>"
	      );

	      contentEl.innerHTML = mdText;
	    } catch (e) {
	      titleEl.textContent = "Error";
	      contentEl.textContent = "No se pudo cargar el archivo seleccionado.";
	    }
	    return;
	  }

	  // fallback: tipo desconocido
	  titleEl.textContent = realPath.split("/").pop();
	  contentEl.innerHTML = `
	    <p>No sé mostrar este tipo de archivo todavía.</p>
	    <p><a href="${realPath}" target="_blank" rel="noopener noreferrer">Abrir directamente</a></p>
	  `;
	})();
  </script>

  <script src="assets/js/generate-index.js"></script>
</body>
</html>

