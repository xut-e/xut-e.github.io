<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>xut | Apuntes</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <!-- highlight.js -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- markdown-it -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>

  <!-- üî• PREPROCESSOR OBSIDIAN -->
  <script src="assets/js/obsidian-preprocessor.js"></script>

  <link rel="icon" type="img/png" href="https://avatars.githubusercontent.com/u/172497238?v=4">
</head>

<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="site-header-inner">
      <div class="site-left">
        <a class="site-brand" href="/" aria-label="xut - inicio">
          <span aria-hidden="true">‚ú±</span>
          <span>xut</span>
        </a>
        <a id="toggle-index" class="site-link" href="#">√çndice</a>
      </div>

      <nav class="site-nav" aria-label="Principal">
        <ul>
          <li><a href="/">Inicio</a></li>
          <li><a href="/sobre-mi.html">Sobre m√≠</a></li>
	  <li><a href="/graph.html">Vista gr√°fica</a></li>
          <li><a href="https://github.com/xut-e" target="_blank" rel="noopener">GitHub</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- LAYOUT -->
  <main class="page-shell">
    <aside class="sidebar" id="indice">
      <h2 id="indice-label">√çndice</h2>
      <div id="dynamic-index"><p>Cargando √≠ndice...</p></div>
    </aside>

    <section class="markdown-body">
      <div id="breadcrumb" class="breadcrumb">Cargando ruta...</div>
      <h1 id="md-title">Cargando‚Ä¶</h1>

      <div id="md-content" style="font-size:.95rem; line-height:1.5;">
        Cargando contenido del apunte‚Ä¶
      </div>

      <div class="nav-buttons">
        <button id="prev-note" title="Anterior">&lt;</button>
        <button id="next-note" title="Siguiente">&gt;</button>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="site-footer-inner">
      <small>¬© <span id="year"></span> xut-e ‚Äî Todos los derechos reservados</small>
      <pre class="ascii" aria-hidden="true">
             ..                      .....          
   .H88x.  :~)88:                 .H8888888h.  ~-.  
  x888888X ~:8888    x.    .      888888888888x  `> 
 ~   "8888X  %88"  .@88k  z88u   X~     `?888888hx~ 
      X8888       ~"8888 ^8888   '      x8.^"*88*"  
   .xxX8888xxxd>    8888  888R    `-:- X8888x       
  :88888888888"     8888  888R         488888>      
  ~   '8888         8888  888R       .. `"88*       
 xx.  X8888:    .   8888 ,888B .   x88888nX"      . 
X888  X88888x.x"   "8888Y 8888"   !"*8888888n..  :  
X88% : '%8888"      `Y"   'YP    '    "*88888888*   
 "*=~    `""                             ^"***"`    
      </pre>
    </div>
  </footer>

<script>
document.getElementById("year").textContent = new Date().getFullYear();
</script>

<script src="assets/js/generate-index.js"></script>

<!-- TOGGLE DEL √çNDICE -->
<script>
window.addEventListener("load", () => {
  const btn = document.getElementById("toggle-index");
  const aside = document.getElementById("indice");
  const shell = document.querySelector(".page-shell");

  const visible = localStorage.getItem("indexVisible") === "true";

  if (visible) {
    aside.classList.remove("hidden");
    shell.classList.remove("full-width");
    btn.textContent = "Ocultar √≠ndice";
    btn.classList.add("active");
  } else {
    aside.classList.add("hidden");
    shell.classList.add("full-width");
    btn.textContent = "Mostrar √≠ndice";
    btn.classList.remove("active");
  }

  btn.addEventListener("click", e => {
    e.preventDefault();
    const hidden = aside.classList.contains("hidden");

    if (hidden) {
      aside.classList.remove("hidden");
      shell.classList.remove("full-width");
      btn.textContent = "Ocultar √≠ndice";
      btn.classList.add("active");
      localStorage.setItem("indexVisible", "true");
    } else {
      aside.classList.add("collapsing");
      shell.classList.add("full-width");
      btn.textContent = "Mostrar √≠ndice";
      btn.classList.remove("active");
      localStorage.setItem("indexVisible", "false");

      setTimeout(() => {
        aside.classList.remove("collapsing");
        aside.classList.add("hidden");
      }, 300);
    }
  });
});
</script>


<!-- ===================================================================================== -->
<!-- =========================== üî• MOTOR MARKDOWN & PREPROCESSOR ========================= -->
<!-- ===================================================================================== -->

<script>
// Parser markdown-it
const mdParser = window.markdownit({
  html: true,
  linkify: true,
  typographer: false,
  breaks: false
});

// Callouts estilo Obsidian
function renderCallouts(md) {
  return md.replace(
    /^>\s*\[!(\w+)\](.*?)(?:\n(?!>)([\s\S]*?))?(?=\n{2,}|$)/gm,
    (full, type, title, body = "") => {
      const header = title.trim() || type.toUpperCase();
      const content = body ? body.replace(/^> ?/gm, "") : "";
      return `
<div class="callout callout-${type.toLowerCase()}">
  <div class="callout-title">${header}</div>
  <div class="callout-body">${content.trim()}</div>
</div>`;
    }
  );
}
</script>


<!-- ===================================================================================== -->
<!-- ============================= üî• RENDER DE MARKDOWN ================================== -->
<!-- ===================================================================================== -->

<script>
(async function () {

  const params = new URLSearchParams(window.location.search);
  const fileParam = params.get("file");

  const titleEl = document.getElementById("md-title");
  const contentEl = document.getElementById("md-content");

  // === Guardar siempre la p√°gina actual (FIX M√ÅS IMPORTANTE) ===
  if (fileParam) {
    localStorage.setItem("indexLastFile", fileParam);
  }

  if (!fileParam) {
    titleEl.textContent = "Sin archivo";
    contentEl.textContent = "No se ha especificado ning√∫n archivo.";
    return;
  }

  const realPath = fileParam.startsWith("content/")
    ? fileParam
    : "content/" + fileParam;

  if (realPath.toLowerCase().endsWith(".md")) {

    try {
      const res = await fetch(realPath);
      if (!res.ok) throw new Error();
      let md = await res.text();

      // T√≠tulo
      const lines = md.split("\n");
      const h1 = lines[0]?.match(/^#\s+(.+)/);
      titleEl.textContent = h1 ? h1[1].trim() : realPath.split("/").pop();
      // Quitar ".md" del t√≠tulo si existe
      titleEl.textContent = titleEl.textContent.replace(/\.md$/i, "");


      // üî• PROCESADOR OBSIDIAN ‚Äî Listas, sublistas, im√°genes, p√°rrafos
      md = ObsidianPreprocessor.process(md);

      // Callouts
      md = renderCallouts(md);

      // markdown-it
      let html = mdParser.render(md);

      // Resaltado c√≥digo
      contentEl.innerHTML = html;
      contentEl.querySelectorAll("pre code").forEach(b => hljs.highlightElement(b));

    } catch {
      titleEl.textContent = "Error";
      contentEl.textContent = "No se pudo cargar el archivo.";
    }

    return;
  }

  // PDFs
  if (realPath.toLowerCase().endsWith(".pdf")) {
    const clean = realPath.split("/").pop().replace(/\.pdf$/, "");
    titleEl.textContent = clean;
    contentEl.innerHTML =
      `<iframe src="${realPath}" width="100%" height="80vh"
        style="border:1px solid var(--border-color,#444)"></iframe>`;
    return;
  }

})();
</script>


<!-- ===================================================================================== -->
<!-- ==============================  üî• BREADCRUMB & NAV  ================================= -->
<!-- ===================================================================================== -->

<script>
window.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(location.search);
  const file = params.get("file");
  const el = document.getElementById("breadcrumb");

  if (!file) { 
    el.textContent = "(Sin ruta)";
    return;
  }

  try {
    const res = await fetch("apuntes/arbol.json");
    if (!res.ok) throw new Error();
    await res.json();

    const parts = file
      .replace(/^content\/?/i, "")
      .split("/")
      .filter(Boolean)
      .map(s => s.replace(/\.md$/i, "").replace(/-/g, " "))
      .map(s => s.replace(/\b\w/g, c => c.toUpperCase()));

    el.textContent = parts.join(" > ") || "(Sin ruta)";

  } catch {
    el.textContent = "(Error al generar ruta)";
  }
});
</script>

<script>
window.addEventListener("DOMContentLoaded", async () => {
  const btnPrev = document.getElementById("prev-note");
  const btnNext = document.getElementById("next-note");

  const params = new URLSearchParams(location.search);
  const current = params.get("file");
  if (!current) return;

  let tree;
  try {
    const res = await fetch("apuntes/arbol.json");
    tree = await res.json();
  } catch {
    return;
  }

  function flatten(node) {
    let out = [];
    if (Array.isArray(node)) {
      node.forEach(n => out.push(...flatten(n)));
    } else if (node.type === "directory") {
      node.contents?.forEach(n => out.push(...flatten(n)));
    } else if (node.type === "file" && node.path.endsWith(".md")) {
      out.push(node.path);
    }
    return out;
  }

  const allFiles = flatten(tree)
    .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

  const normalizedCurrent = current
    .replace(/^content\//i, "")
    .replace(/^Ciberseguridad\//i, "");

  const normalizedList = allFiles.map(p =>
    p.replace(/^content\//i, "").replace(/^Ciberseguridad\//i, "")
  );

  const index = normalizedList.indexOf(normalizedCurrent);
  if (index === -1) return;

  const prev = index > 0 ? allFiles[index - 1] : null;
  const next = index < allFiles.length - 1 ? allFiles[index + 1] : null;

  function goTo(path) {
    window.location.href = `markdown-viewer.html?file=${encodeURIComponent(path)}`;
  }

  if (prev) {
    btnPrev.disabled = false;
    btnPrev.addEventListener("click", () => goTo(prev));
  }

  if (next) {
    btnNext.disabled = false;
    btnNext.addEventListener("click", () => goTo(next));
  }

});
</script>

</body>
</html>

