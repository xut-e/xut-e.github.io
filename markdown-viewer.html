<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>xut | Apuntes</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="site-header-inner">
      <a class="site-brand" href="/" aria-label="xut - inicio">
        <span aria-hidden="true">✱</span>
        <span>xut</span>
      </a>

      <nav class="site-nav" aria-label="Principal">
        <ul>
          <li><a href="/">Inicio</a></li>
          <li><a href="/#indice">Apuntes</a></li>
          <li><a href="/sobre-mi.html">Sobre mí</a></li>
          <li><a href="https://github.com/xut-e" rel="noopener" target="_blank">GitHub</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- LAYOUT -->
  <main class="page-shell">
  <!-- SIDEBAR DINÁMICO IGUAL QUE EN INDEX -->
  <aside class="sidebar" id="indice">
    <h2 id="indice-label">Índice</h2>
    <div id="dynamic-index">
      <p>Cargando índice...</p>
    </div>
  </aside>

  <!-- CONTENIDO MARKDOWN -->
  <section class="markdown-body">
    <h1 id="md-title">Cargando…</h1>
    <div id="md-content" style="font-size:.95rem; line-height:1.5;">
      Cargando contenido del apunte…
    </div>
  </section>
</main>


  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="site-footer-inner">
      <small>© <span id="year"></span> xut-e — Todos los derechos reservados</small>
      <pre class="ascii" aria-hidden="true">
             ..                      .....          
   .H88x.  :~)88:                 .H8888888h.  ~-.  
  x888888X ~:8888    x.    .      888888888888x  `> 
 ~   "8888X  %88"  .@88k  z88u   X~     `?888888hx~ 
      X8888       ~"8888 ^8888   '      x8.^"*88*"  
   .xxX8888xxxd>    8888  888R    `-:- X8888x       
  :88888888888"     8888  888R         488888>      
  ~   '8888         8888  888R       .. `"88*       
 xx.  X8888:    .   8888 ,888B .   x88888nX"      . 
X888  X88888x.x"   "8888Y 8888"   !"*8888888n..  :  
X88% : '%8888"      `Y"   'YP    '    "*88888888*   
 "*=~    `""                             ^"***"`    
      </pre>
    </div>
  </footer>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Leer ?file=...
    const params = new URLSearchParams(window.location.search);
    let fileRel = params.get("file");

    if (!fileRel) {
      document.getElementById("md-title").textContent = "Error";
      document.getElementById("md-content").innerHTML =
        "<p style='color:red;'>No se especificó ningún archivo.</p>";
    } else {
      if (!fileRel.startsWith("content/")) {
        fileRel = "content/" + fileRel;
      }

      document.getElementById("md-title").textContent = fileRel
        .split("/")
        .pop()
        .replace(".md", "");

      fetch(fileRel)
        .then(res => {
          if (!res.ok) throw new Error("No se pudo cargar el archivo: " + fileRel);
          return res.text();
        })
        .then(mdText => {
          const IMAGE_BASE = "content/Ciberseguridad/Z Imagenes/";

          // --- 1) Reemplazar sintaxis Obsidian [[imagen]] o ![[imagen]] -> Markdown imagen estándar
          mdText = mdText.replace(/!?(\[\[)([^\]]+)\]\]/g, (match, _, inner) => {
            const fileName = inner.trim();

            // ya viene con ruta absoluta "content/..."
            if (fileName.startsWith("content/")) {
              return `![](${fileName})`;
            }

            // construir ruta dentro de Z Imagenes
            const imgSrc = IMAGE_BASE + fileName;
            const safeSrc = imgSrc.replace(/\s/g, "%20"); // espacios a %20
            return `![](${safeSrc})`;
          });

          // --- 2) Normalizar sintaxis de links estilo Markdown que vienen feos
          // Casos:
          // [texto] (url)  => [texto](url)
          // [texto]((url)) => [texto](url)
          // [texto]( url ) => [texto](url)
          mdText = mdText
            .replace(/\]\s+\(/g, "](")                     // quita espacios entre ] y (
            .replace(/\]\(\((https?:[^\)]+)\)\)/g, "]($1)") // ((url)) -> (url)
            .replace(/\]\(\s*([^)]+)\s*\)/g, "]($1)");      // ( url ) -> (url)

          // --- 3) Generar HTML inicial con marked
          marked.setOptions({
            highlight: function (code, lang) {
              const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
              return hljs.highlight(code, { language: validLang }).value;
            },
            breaks: true
          });

          let html = marked.parse(mdText);

          // --- 4) Post-procesar enlaces que aún hayan quedado literales en forma [texto](link)
          // Esto convierte cualquier resto plano "[texto](https://loquesea)" en <a href="https://loquesea">texto</a>
          // y le pone target="_blank".
          html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, (match, text, url) => {
            const cleanUrl = url.trim().replace(/\s/g, "%20");
            return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer">${text}</a>`;
          });

          // --- 5) Inyectar en el DOM
          const contentEl = document.getElementById("md-content");
          contentEl.classList.add("markdown-body");
          contentEl.innerHTML = html;

          // --- 6) Asegurar que los <a> que ya existían también abran en nueva pestaña
          contentEl.querySelectorAll("a").forEach(a => {
            const href = a.getAttribute("href");
            if (href && /^https?:\/\//i.test(href)) {
              a.setAttribute("target", "_blank");
              a.setAttribute("rel", "noopener noreferrer");
            }
            if (href) {
              try {
                a.setAttribute("href", decodeURIComponent(href));
              } catch (e) {}
            }
          });

          // --- 7) Resaltado de código
          document.querySelectorAll('pre code').forEach(el => {
            hljs.highlightElement(el);
          });
        })
        .catch(err => {
          document.getElementById("md-content").innerHTML =
            "<p style='color:red;'>" + err.message + "</p>";
        });
    }
  </script>
  <script src="assets/js/generate-index.js"></script>
</body>
</html>

