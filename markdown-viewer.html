<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>xut | Apuntes</title>
  <link rel="stylesheet" href="assets/css/main.css">
</head>

<body>
  <!-- HEADER igual que index -->
  <header class="site-header">
    <div class="site-header-inner">
      <a class="site-brand" href="/" aria-label="xut - inicio">
        <span aria-hidden="true">✱</span>
        <span>xut</span>
      </a>

      <nav class="site-nav" aria-label="Principal">
        <ul>
          <li><a href="/">Inicio</a></li>
          <li><a href="/#indice">Apuntes</a></li>
          <li><a href="/sobre-mi.html">Sobre mí</a></li>
          <li><a href="https://github.com/xut-e" rel="noopener" target="_blank">GitHub</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- LAYOUT 2 COLUMNAS -->
  <main class="page-shell">
    <!-- Reutilizamos la misma sidebar que index -->
    <aside class="sidebar">
      <h2>Índice</h2>
      <p style="font-size:.8rem;color:var(--text-dim);margin-top:0;">← vuelve al inicio para el árbol completo.</p>
      <p style="margin:0;"><a href="/" style="color:var(--accent);text-decoration:none;">Inicio</a></p>
    </aside>

    <section class="markdown-body">
      <h1 id="md-title">Cargando…</h1>
      <div id="md-content" style="font-size:.95rem; line-height:1.5;">
        Cargando contenido del apunte…
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="site-footer-inner">
      <small>© <span id="year"></span> xut-e — Todos los derechos reservados</small>
      <pre class="ascii" aria-hidden="true">
             ..                      .....          
   .H88x.  :~)88:                 .H8888888h.  ~-.  
  x888888X ~:8888    x.    .      888888888888x  `> 
 ~   "8888X  %88"  .@88k  z88u   X~     `?888888hx~ 
      X8888       ~"8888 ^8888   '      x8.^"*88*"  
   .xxX8888xxxd>    8888  888R    `-:- X8888x       
  :88888888888"     8888  888R         488888>      
  ~   '8888         8888  888R       .. `"88*       
 xx.  X8888:    .   8888 ,888B .   x88888nX"      . 
X888  X88888x.x"   "8888Y 8888"   !"*8888888n..  :  
X88% : '%8888"      `Y"   'YP    '    "*88888888*   
 "*=~    `""                             ^"***"`    
      </pre>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // 1. leer ?file=...
    const params = new URLSearchParams(window.location.search);
    const fileRel = params.get('file'); // ej: apuntes/thm/1-pre-security/1. Pre Security.md

    const titleEl = document.getElementById('md-title');
    const contentEl = document.getElementById('md-content');

    if (!fileRel) {
      titleEl.textContent = "Error";
      contentEl.innerHTML = "<p style='color:red;'>No se especificó ningún archivo.</p>";
    } else {
      titleEl.textContent = fileRel.split('/').pop().replace('.md','');

      // MUY IMPORTANTE:
      // fetch SIN "/" inicial => relativo al repo GitHub Pages
      fetch(fileRel)
        .then(res => {
          if (!res.ok) {
            throw new Error("No se pudo cargar el archivo: " + fileRel);
          }
          return res.text();
        })
        .then(mdText => {
          // render cutre: saltos de línea => <p> y ## => <h2> etc.
          // (no tenemos marked.js offline, así que hago un parser mínimo rápido)
          const html = basicMarkdownToHtml(mdText);
          contentEl.innerHTML = html;
        })
        .catch(err => {
          contentEl.innerHTML = "<p style='color:red;'>" + err.message + "</p>";
        });
    }

    // parser markdown muy básico (titulares, codeblocks, párrafos)
    function escapeHTML(str){
      return str
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    function basicMarkdownToHtml(md) {
      // code blocks ``` ... ```
      let html = "";
      const lines = md.split("\n");
      let inCode = false;
      let codeBuf = [];

      function flushParagraph(buf){
        const text = buf.join(" ").trim();
        if (!text) return;
        html += "<p>" + text
          .replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")
          .replace(/`([^`]+)`/g,"<code>$1</code>")
          + "</p>";
      }

      let pBuf = [];

      for (let line of lines){
        if (line.trim().startsWith("```")) {
          if (!inCode){
            // abrir bloque code
            flushParagraph(pBuf); pBuf=[];
            inCode = true;
            codeBuf = [];
          } else {
            // cerrar bloque code
            inCode = false;
            html += "<pre><code>" + escapeHTML(codeBuf.join("\n")) + "</code></pre>";
            codeBuf=[];
          }
          continue;
        }

        if (inCode){
          codeBuf.push(line);
          continue;
        }

        // headings
        if (/^#{1,6}\s+/.test(line)) {
          flushParagraph(pBuf); pBuf=[];
          const m = line.match(/^(#{1,6})\s+(.*)$/);
          const level = m[1].length;
          const text = m[2];
          html += `<h${level}>${text}</h${level}>`;
          continue;
        }

        if (line.trim()===""){
          flushParagraph(pBuf); pBuf=[];
        } else {
          pBuf.push(line.trim());
        }
      }

      flushParagraph(pBuf);
      if (inCode){
        html += "<pre><code>" + escapeHTML(codeBuf.join("\n")) + "</code></pre>";
      }

      return html;
    }
  </script>
</body>
</html>

