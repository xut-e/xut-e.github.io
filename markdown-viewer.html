<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>xut | Apuntes</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="icon" type "img/png" href="https://avatars.githubusercontent.com/u/172497238?v=4">
</head>

<body>
  <!-- HEADER -->
	<header class="site-header">
	  <div class="site-header-inner">
	    <div class="site-left">
	      <a class="site-brand" href="/" aria-label="xut - inicio">
		<span aria-hidden="true">‚ú±</span>
		<span>xut</span>
	      </a>
	      <a id="toggle-index" class="site-link" href="#">√çndice</a>
	    </div>

	    <nav class="site-nav" aria-label="Principal">
	      <ul>
		<li><a href="/">Inicio</a></li>
		<li><a href="/sobre-mi.html">Sobre m√≠</a></li>
		<li><a href="https://github.com/xut-e" rel="noopener" target="_blank">GitHub</a></li>
	      </ul>
	    </nav>
	  </div>
	</header>
	 

  <!-- LAYOUT -->
  <main class="page-shell">
    <!-- SIDEBAR DIN√ÅMICO IGUAL QUE EN INDEX -->
    <aside class="sidebar" id="indice">
      <h2 id="indice-label">√çndice</h2>
      <div id="dynamic-index">
        <p>Cargando √≠ndice...</p>
      </div>
    </aside>

    <!-- CONTENIDO MARKDOWN -->
    <section class="markdown-body">
      <div id="breadcrumb" class="breadcrumb">Cargando ruta...</div>
      <h1 id="md-title">Cargando‚Ä¶</h1>

      <div id="md-content" style="font-size:.95rem; line-height:1.5;">
        Cargando contenido del apunte‚Ä¶
      </div>

      <div class="nav-buttons">
        <button id="prev-note" title="Anterior">&lt;</button>
        <button id="next-note" title="Siguiente">&gt;</button>
      </div>
    </section>


  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="site-footer-inner">
      <small>¬© <span id="year"></span> xut-e ‚Äî Todos los derechos reservados</small>
      <pre class="ascii" aria-hidden="true">
             ..                      .....          
   .H88x.  :~)88:                 .H8888888h.  ~-.  
  x888888X ~:8888    x.    .      888888888888x  `> 
 ~   "8888X  %88"  .@88k  z88u   X~     `?888888hx~ 
      X8888       ~"8888 ^8888   '      x8.^"*88*"  
   .xxX8888xxxd>    8888  888R    `-:- X8888x       
  :88888888888"     8888  888R         488888>      
  ~   '8888         8888  888R       .. `"88*       
 xx.  X8888:    .   8888 ,888B .   x88888nX"      . 
X888  X88888x.x"   "8888Y 8888"   !"*8888888n..  :  
X88% : '%8888"      `Y"   'YP    '    "*88888888*   
 "*=~    `""                             ^"***"`    
      </pre>
    </div>
  </footer>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    (async function () {
      const params = new URLSearchParams(window.location.search);
      const fileParam = params.get("file");

      const titleEl = document.getElementById("md-title");
      const contentEl = document.getElementById("md-content");

      if (!fileParam) {
        titleEl.textContent = "Sin archivo";
        contentEl.textContent = "No se ha especificado ning√∫n archivo.";
        return;
      }

      // ruta real en el servidor
      const realPath = fileParam.startsWith("content/")
        ? fileParam
        : "content/" + fileParam;

      const lower = realPath.toLowerCase();

      // Si es PDF -> incrustar visor PDF
      if (lower.endsWith(".pdf")) {
        const cleanName = realPath.split("/").pop().replace(/\.pdf$/i, "");
        titleEl.textContent = cleanName;

        contentEl.innerHTML = "";

        const viewer = document.createElement("iframe");
        viewer.src = realPath;
        viewer.style.width = "100%";
        viewer.style.height = "80vh";
        viewer.style.border = "1px solid var(--border-color, #444)";
        viewer.loading = "lazy";

        contentEl.appendChild(viewer);
        return;
      }

      // Si es Markdown -> fetch + render
      if (lower.endsWith(".md")) {
        try {
          const res = await fetch(realPath);
          if (!res.ok) throw new Error("No se pudo cargar el archivo");
          let mdText = await res.text();

          // t√≠tulo = primera l√≠nea tipo "# ..." o sino nombre de archivo
          const lines = mdText.split("\n");
          const h1Match = lines[0]?.match(/^#\s+(.+)/);
          if (h1Match) {
            titleEl.textContent = h1Match[1].trim();
          } else {
            titleEl.textContent = realPath.split("/").pop().replace(/\.md$/i, "");
          }

          // Renderizado completo de Markdown (tablas, listas, etc.)
          mdText = marked.parse(mdText, {
            gfm: true,
            breaks: true,
          });

          // Corrige im√°genes tipo Obsidian ![[imagen.png]]
    	  mdText = mdText.replace(/!\[\[(.+?)\]\]/g, (match, p1) => {
	    const src = decodeURIComponent(p1.trim()); // decodifica espacios
	    const normalized = src
	      .replace(/^Pasted image\s+/i, "Pasted image ") // asegura formato correcto
	      .replace(/\s+/g, " "); // normaliza espacios m√∫ltiples

	    return `<img src="/content/Ciberseguridad/Z%20Imagenes/${encodeURIComponent(normalized)}" alt="${normalized}">`;
	  });


          // Asegura que los enlaces externos se abran en nueva pesta√±a
          mdText = mdText.replace(/<a href="(https?:\/\/[^"]+)">/g,
            '<a href="$1" target="_blank" rel="noopener">');

          // Inyecta el HTML procesado
          contentEl.innerHTML = mdText;

          // Resalta el c√≥digo si existe
          contentEl.querySelectorAll('pre code').forEach(block => {
            hljs.highlightElement(block);
          });

        } catch (e) {
          titleEl.textContent = "Error";
          contentEl.textContent = "No se pudo cargar el archivo seleccionado.";
        }
        return;
      }

      // fallback: tipo desconocido
      titleEl.textContent = realPath.split("/").pop();
      contentEl.innerHTML = `
        <p>No s√© mostrar este tipo de archivo todav√≠a.</p>
        <p><a href="${realPath}" target="_blank" rel="noopener noreferrer">Abrir directamente</a></p>
      `;
    })();
  </script>

   <script src="assets/js/generate-index.js"></script>

   <script>
// ======== Mostrar / Ocultar √≠ndice con persistencia ========
window.addEventListener("load", () => {
  const btn = document.getElementById("toggle-index");
  const aside = document.getElementById("indice");
  const pageShell = document.querySelector(".page-shell");
  if (!btn || !aside || !pageShell) return;

  // --- Leer estado previo de localStorage ---
  const savedState = localStorage.getItem("indexVisible") ?? "true";
  const isVisible = savedState === "true";

  // --- Aplicar estado inicial ---
  if (isVisible) {
    aside.classList.remove("hidden");
    pageShell.classList.remove("full-width");
    btn.textContent = "Ocultar √≠ndice";
    btn.classList.add("active");
  } else {
    aside.classList.add("hidden");
    pageShell.classList.add("full-width");
    btn.textContent = "Mostrar √≠ndice";
    btn.classList.remove("active");
  }

  // --- Escuchar clic para alternar estado ---
  btn.addEventListener("click", e => {
    e.preventDefault();
    const currentlyHidden = aside.classList.contains("hidden");

    if (currentlyHidden) {
      // Mostrar √≠ndice
      aside.classList.remove("hidden");
      pageShell.classList.remove("full-width");
      btn.textContent = "Ocultar √≠ndice";
      btn.classList.add("active");
      localStorage.setItem("indexVisible", "true");
    } else {
      // Ocultar √≠ndice (con animaci√≥n)
      aside.classList.add("collapsing");
      pageShell.classList.add("full-width");
      btn.textContent = "Mostrar √≠ndice";
      btn.classList.remove("active");
      localStorage.setItem("indexVisible", "false");

      setTimeout(() => {
        aside.classList.remove("collapsing");
        aside.classList.add("hidden");
      }, 300); // coincide con la transici√≥n CSS
    }
  });
});
</script>



<script>
window.addEventListener("load", async () => {
  const params = new URLSearchParams(window.location.search);
  const currentFile = params.get("file");
  if (!currentFile) {
    console.warn("‚ö†Ô∏è No se ha pasado par√°metro ?file=");
    return;
  }

  console.log("üìÑ Archivo actual:", currentFile);

  const prevBtn = document.getElementById("prev-note");
  const nextBtn = document.getElementById("next-note");

  try {
    const res = await fetch("index.json");
    if (!res.ok) throw new Error("No se pudo cargar index.json");
    const data = await res.json();

    // === Funci√≥n recursiva para recorrer el √°rbol ===
    function flattenTree(node, path = "") {
      if (!node) return [];
      let files = [];

      if (Array.isArray(node)) {
        node.forEach(n => files.push(...flattenTree(n, path)));
      } else if (node.type === "directory") {
        const newPath = path ? `${path}/${node.name}` : node.name;

        if (node.name === "Z Imagenes") {
          console.log("üß© Ignorado directorio de im√°genes:", newPath);
          return files;
        }
        node.contents?.forEach(n => files.push(...flattenTree(n, newPath)));
      } else if (node.type === "file" && node.name.endsWith(".md")) {
        const filePath = `${path}/${node.name}`;
        const parts = filePath.split("/");
        const fileName = node.name;
        const parentName = parts[parts.length - 2];

        // Reglas de exclusi√≥n
        if (fileName.replace(/\.md$/, "") === parentName) {
          console.log("‚õî Ignorado √≠ndice de carpeta:", filePath);
          return files;
        }
        if (/^0\./.test(fileName)) {
          console.log("‚õî Ignorado (empieza por 0.):", filePath);
          return files;
        }
        if (/^\d+\.\s/.test(fileName) && parts.length === 2) {
          console.log("‚õî Ignorado √≠ndice de curso:", filePath);
          return files;
        }

        files.push(filePath);
      }
      return files;
    }

    // === Si el nodo ra√≠z es ".", entrar en sus contents ===
    const root = data[0]?.name === "." ? data[0].contents : data;
   
    let allFiles = flattenTree(root);

// üî¢ Orden natural: 1.md < 2.md < 10.md
allFiles.sort((a, b) => {
  const clean = s => s.toLowerCase().replace(/\\/g, "/");
  const aParts = clean(a).split("/");
  const bParts = clean(b).split("/");
  const aName = aParts[aParts.length - 1];
  const bName = bParts[bParts.length - 1];

  // Extraer n√∫meros iniciales (por ejemplo, "10. " ‚Üí 10)
  const numA = parseFloat(aName.match(/^(\d+(?:\.\d+)?)/)?.[1]) || 0;
  const numB = parseFloat(bName.match(/^(\d+(?:\.\d+)?)/)?.[1]) || 0;

  if (aParts.slice(0, -1).join("/") !== bParts.slice(0, -1).join("/")) {
    // Mantiene orden jer√°rquico (por carpeta)
    return clean(a).localeCompare(clean(b));
  }

  // Dentro de la misma carpeta, ordena por n√∫mero si existe
  if (numA !== numB) return numA - numB;

  // Si no hay n√∫mero, usa orden alfab√©tico
  return aName.localeCompare(bName, undefined, { numeric: true });
});



    console.log("‚úÖ Archivos v√°lidos encontrados:", allFiles.length);
    console.table(allFiles);

    const normalize = str =>
      str.replace(/\\/g, "/").replace(/%20/g, " ").trim().toLowerCase();

    // Permitir coincidencias aunque haya prefijos distintos
    const idx = allFiles.findIndex(p => normalize(currentFile).endsWith(normalize(p)));
    console.log("üîé √çndice actual:", idx);

    if (idx === -1) {
      console.warn("‚ö†Ô∏è Archivo no encontrado en index.json:", currentFile);
      return;
    }

    // ======= Determinar prefijo actual =======
    const matchPrefix = currentFile.match(/^([^/]+\/THM)\//);
    const basePrefix = matchPrefix ? matchPrefix[1] : "Ciberseguridad/THM";
    console.log("üìÅ Prefijo base detectado:", basePrefix);

    // ======= Funci√≥n para construir la ruta correcta =======
    function buildFullPath(target) {
      if (target.startsWith(basePrefix) || target.startsWith("Ciberseguridad/"))
        return target;

      if (target.startsWith("THM"))
        return `Ciberseguridad/${target}`;

      return `${basePrefix}/${target}`;
    }

    // ======= Configurar botones =======
    if (idx > 0) {
      prevBtn.addEventListener("click", () => {
        const target = allFiles[idx - 1];
        const fullPath = buildFullPath(target);
        console.log("‚¨ÖÔ∏è Navegando a anterior:", fullPath);
        window.location.href = `markdown-viewer.html?file=${encodeURIComponent(fullPath)}`;
      });
    } else {
      prevBtn.disabled = true;
      prevBtn.style.opacity = 0.5;
      prevBtn.style.cursor = "default";
    }

    if (idx < allFiles.length - 1) {
      nextBtn.addEventListener("click", () => {
        const target = allFiles[idx + 1];
        const fullPath = buildFullPath(target);
        console.log("‚û°Ô∏è Navegando a siguiente:", fullPath);
        window.location.href = `markdown-viewer.html?file=${encodeURIComponent(fullPath)}`;
      });
    } else {
      nextBtn.disabled = true;
      nextBtn.style.opacity = 0.5;
      nextBtn.style.cursor = "default";
    }

  } catch (err) {
    console.error("üí• Error en navegaci√≥n entre notas:", err);
  }
});
</script>

<script>
// ======== Sincronizar √≠ndice lateral con la nota actual (con autocierre de ramas viejas) ========
window.addEventListener("load", () => {
  const params = new URLSearchParams(window.location.search);
  const currentFile = params.get("file");
  if (!currentFile) return;

  // normaliza rutas para poder compararlas sin l√≠os de may√∫sculas/espacios/encoding
  const normalize = str =>
    str
      .replace(/\\/g, "/")
      .replace(/%2F/gi, "/")
      .replace(/%20/gi, " ")
      .trim()
      .toLowerCase();

  // extrae s√≥lo la parte despu√©s de ?file= de un href tipo
  // "markdown-viewer.html?file=Ciberseguridad/THM/..."
  function extractFileFromHref(href) {
    if (!href) return "";
    const i = href.indexOf("?file=");
    if (i === -1) return href;
    return href.substring(i + 6); // 6 = length of "?file="
  }

  function highlightInIndex() {
    const links = document.querySelectorAll("#dynamic-index a.tree-link");
    if (links.length === 0) return false; // √≠ndice a√∫n no generado

    // 1. Encontrar el <a> cuyo destino coincide con la nota actual
    let currentLink = null;
    for (const link of links) {
      const linkFilePart = extractFileFromHref(link.getAttribute("href"));
      if (normalize(currentFile) === normalize(linkFilePart)) {
        currentLink = link;
        break;
      }
    }

    if (!currentLink) {
      console.warn("‚ö†Ô∏è No se encontr√≥ el enlace actual en el √≠ndice:", currentFile);
      return false;
    }

    // 2. Quitar highlight anterior
    document.querySelectorAll("#dynamic-index .tree-link.current-page")
      .forEach(el => el.classList.remove("current-page"));

    // 3. Marcar el actual
    currentLink.classList.add("current-page");

    // 4. Cerrar TODAS las ramas <details> primero‚Ä¶
    const allDetails = document.querySelectorAll("#dynamic-index details");
    allDetails.forEach(det => { det.open = false; });

    // 5. ‚Ä¶y ahora volver a abrir s√≥lo la cadena padre de currentLink
    let parent = currentLink.closest("details");
    while (parent) {
      parent.open = true;
      parent = parent.parentElement?.closest("details");
    }

    // 6. Scroll suave al enlace actual (√∫til si est√°s en otra zona del √≠ndice)
    setTimeout(() => {
      currentLink.scrollIntoView({ behavior: "smooth", block: "center" });
    }, 200);

    console.log("üåø √çndice sincronizado con:", currentLink.textContent.trim());
    return true;
  }

  // Intentar varias veces hasta que generate-index.js haya construido el √°rbol
  let tries = 0;
  const interval = setInterval(() => {
    tries++;
    const ok = highlightInIndex();
    if (ok || tries > 30) clearInterval(interval);
  }, 200);
});
</script>


<script>
window.addEventListener("load", async () => {
  const params = new URLSearchParams(window.location.search);
  const currentFile = params.get("file");
  if (!currentFile) return;

  const breadcrumbEl = document.getElementById("breadcrumb");
  if (!breadcrumbEl) return;

  try {
    const res = await fetch("index.json");
    if (!res.ok) throw new Error("No se pudo cargar index.json");
    const data = await res.json();

    // üîç Busca recursivamente el archivo y devuelve la jerarqu√≠a
    function findPath(node, target, path = []) {
      if (!node) return null;
      if (Array.isArray(node)) {
        for (const child of node) {
          const found = findPath(child, target, path);
          if (found) return found;
        }
        return null;
      }
      if (node.type === "directory") {
        const newPath = [...path, node.name];
        for (const c of node.contents || []) {
          const found = findPath(c, target, newPath);
          if (found) return found;
        }
      } else if (node.type === "file") {
        const filePath = [...path, node.name].join("/");
        const normalize = s => s.replace(/\\/g, "/").replace(/%20/g, " ").toLowerCase();
        if (normalize(target).endsWith(normalize(filePath))) {
          return [...path, node.name];
        }
      }
      return null;
    }

    const root = data[0]?.name === "." ? data[0].contents : data;
    const pathArr = findPath(root, currentFile);

    if (pathArr) {
      // ‚úÖ Detectar autom√°ticamente si est√°s en THM, HTB, Maquinas, etc.
      const baseFolder = pathArr.find(p =>
        ["THM", "HTB", "Maquinas"].includes(p)
      ) || pathArr[0];

      // üîß Generar ruta completa con n√∫meros intactos
      const nicePath = pathArr
        .filter(p => p !== "." && p !== "content")
        .map(p => p.replace(/\.md$/i, ""))
        .join(" > ");

      // ü™∂ Mostrar solo desde la carpeta base (ej. THM)
      const idx = nicePath.indexOf(baseFolder);
      breadcrumbEl.textContent =
        idx !== -1 ? nicePath.slice(idx) : nicePath;
    } else {
      breadcrumbEl.textContent = "(Ruta no encontrada)";
    }

  } catch (e) {
    console.error("üí• Error generando breadcrumb:", e);
    breadcrumbEl.textContent = "(Error al cargar ruta)";
  }
});
</script>



</body>
</html>

