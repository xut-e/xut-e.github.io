<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>xut | Apuntes</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="icon" type "img/png" href="https://avatars.githubusercontent.com/u/172497238?v=4">
</head>

<body>
  <!-- HEADER -->
	<header class="site-header">
	  <div class="site-header-inner">
	    <div class="site-left">
	      <a class="site-brand" href="/" aria-label="xut - inicio">
		<span aria-hidden="true">✱</span>
		<span>xut</span>
	      </a>
	      <a id="toggle-index" class="site-link" href="#">Índice</a>
	    </div>

	    <nav class="site-nav" aria-label="Principal">
	      <ul>
		<li><a href="/">Inicio</a></li>
		<li><a href="/#indice">Apuntes</a></li>
		<li><a href="/sobre-mi.html">Sobre mí</a></li>
		<li><a href="https://github.com/xut-e" rel="noopener" target="_blank">GitHub</a></li>
	      </ul>
	    </nav>
	  </div>
	</header>
	 

  <!-- LAYOUT -->
  <main class="page-shell">
    <!-- SIDEBAR DINÁMICO IGUAL QUE EN INDEX -->
    <aside class="sidebar" id="indice">
      <h2 id="indice-label">Índice</h2>
      <div id="dynamic-index">
        <p>Cargando índice...</p>
      </div>
    </aside>

    <!-- CONTENIDO MARKDOWN -->
    <section class="markdown-body">
      <h1 id="md-title">Cargando…</h1>
      <div id="md-content" style="font-size:.95rem; line-height:1.5;">
        Cargando contenido del apunte…
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="site-footer-inner">
      <small>© <span id="year"></span> xut-e — Todos los derechos reservados</small>
      <pre class="ascii" aria-hidden="true">
             ..                      .....          
   .H88x.  :~)88:                 .H8888888h.  ~-.  
  x888888X ~:8888    x.    .      888888888888x  `> 
 ~   "8888X  %88"  .@88k  z88u   X~     `?888888hx~ 
      X8888       ~"8888 ^8888   '      x8.^"*88*"  
   .xxX8888xxxd>    8888  888R    `-:- X8888x       
  :88888888888"     8888  888R         488888>      
  ~   '8888         8888  888R       .. `"88*       
 xx.  X8888:    .   8888 ,888B .   x88888nX"      . 
X888  X88888x.x"   "8888Y 8888"   !"*8888888n..  :  
X88% : '%8888"      `Y"   'YP    '    "*88888888*   
 "*=~    `""                             ^"***"`    
      </pre>
    </div>
  </footer>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    (async function () {
      const params = new URLSearchParams(window.location.search);
      const fileParam = params.get("file");

      const titleEl = document.getElementById("md-title");
      const contentEl = document.getElementById("md-content");

      if (!fileParam) {
        titleEl.textContent = "Sin archivo";
        contentEl.textContent = "No se ha especificado ningún archivo.";
        return;
      }

      // ruta real en el servidor
      const realPath = fileParam.startsWith("content/")
        ? fileParam
        : "content/" + fileParam;

      const lower = realPath.toLowerCase();

      // Si es PDF -> incrustar visor PDF
      if (lower.endsWith(".pdf")) {
        const cleanName = realPath.split("/").pop().replace(/\.pdf$/i, "");
        titleEl.textContent = cleanName;

        contentEl.innerHTML = "";

        const viewer = document.createElement("iframe");
        viewer.src = realPath;
        viewer.style.width = "100%";
        viewer.style.height = "80vh";
        viewer.style.border = "1px solid var(--border-color, #444)";
        viewer.loading = "lazy";

        contentEl.appendChild(viewer);
        return;
      }

      // Si es Markdown -> fetch + render
      if (lower.endsWith(".md")) {
        try {
          const res = await fetch(realPath);
          if (!res.ok) throw new Error("No se pudo cargar el archivo");
          let mdText = await res.text();

          // título = primera línea tipo "# ..." o sino nombre de archivo
          const lines = mdText.split("\n");
          const h1Match = lines[0]?.match(/^#\s+(.+)/);
          if (h1Match) {
            titleEl.textContent = h1Match[1].trim();
          } else {
            titleEl.textContent = realPath.split("/").pop().replace(/\.md$/i, "");
          }

          // Renderizado completo de Markdown (tablas, listas, etc.)
          mdText = marked.parse(mdText, {
            gfm: true,
            breaks: true,
          });

          // Corrige imágenes tipo Obsidian ![[imagen.png]]
    	  mdText = mdText.replace(/!\[\[(.+?)\]\]/g, (match, p1) => {
	    const src = decodeURIComponent(p1.trim()); // decodifica espacios
	    const normalized = src
	      .replace(/^Pasted image\s+/i, "Pasted image ") // asegura formato correcto
	      .replace(/\s+/g, " "); // normaliza espacios múltiples

	    return `<img src="/content/Ciberseguridad/Z%20Imagenes/${encodeURIComponent(normalized)}" alt="${normalized}">`;
	  });


          // Asegura que los enlaces externos se abran en nueva pestaña
          mdText = mdText.replace(/<a href="(https?:\/\/[^"]+)">/g,
            '<a href="$1" target="_blank" rel="noopener">');

          // Inyecta el HTML procesado
          contentEl.innerHTML = mdText;

          // Resalta el código si existe
          contentEl.querySelectorAll('pre code').forEach(block => {
            hljs.highlightElement(block);
          });

        } catch (e) {
          titleEl.textContent = "Error";
          contentEl.textContent = "No se pudo cargar el archivo seleccionado.";
        }
        return;
      }

      // fallback: tipo desconocido
      titleEl.textContent = realPath.split("/").pop();
      contentEl.innerHTML = `
        <p>No sé mostrar este tipo de archivo todavía.</p>
        <p><a href="${realPath}" target="_blank" rel="noopener noreferrer">Abrir directamente</a></p>
      `;
    })();
  </script>

   <script src="assets/js/generate-index.js"></script>

   <script>
window.addEventListener("load", () => {
  const btn = document.getElementById("toggle-index");
  const aside = document.getElementById("indice");
  const pageShell = document.querySelector(".page-shell");

  if (!btn || !aside || !pageShell) return;

  // Estado inicial
  btn.textContent = "Ocultar índice";
  btn.classList.add("active");

  btn.addEventListener("click", (e) => {
    e.preventDefault();

    const isHidden = aside.classList.contains("hidden");

    if (isHidden) {
      // Mostrar índice
      aside.classList.remove("hidden");
      pageShell.classList.remove("full-width");
      btn.textContent = "Ocultar índice";
      btn.classList.add("active");
    } else {
      // Animación de colapso
      aside.classList.add("collapsing");
      pageShell.classList.add("full-width");
      btn.textContent = "Mostrar índice";
      btn.classList.remove("active");

      // Espera la animación antes de ocultar
      setTimeout(() => {
        aside.classList.remove("collapsing");
        aside.classList.add("hidden");
      }, 300); // coincide con el CSS
    }
  });
});
</script>


</body>
</html>

