<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>xut | Apuntes</title>

  <link rel="stylesheet" href="assets/css/main.css">

  <!-- Markdown & highlight -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <link rel="icon" type="img/png" href="https://avatars.githubusercontent.com/u/172497238?v=4">

  <!-- CONFIGURACI√ìN GLOBAL DE MARKED -->
  <script>
    marked.setOptions({
      gfm: true,
      breaks: false,
      headerIds: true,
      mangle: false,
      smartLists: false,  // dejamos que nuestra l√≥gica mande
      smartypants: false,
      highlight: code => hljs.highlightAuto(code).value
    });
  </script>
</head>

<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="site-header-inner">
      <div class="site-left">
        <a class="site-brand" href="/" aria-label="xut - inicio">
          <span aria-hidden="true">‚ú±</span>
          <span>xut</span>
        </a>
        <a id="toggle-index" class="site-link" href="#">√çndice</a>
      </div>

      <nav class="site-nav" aria-label="Principal">
        <ul>
          <li><a href="/">Inicio</a></li>
          <li><a href="/sobre-mi.html">Sobre m√≠</a></li>
          <li><a href="https://github.com/xut-e" target="_blank" rel="noopener">GitHub</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- LAYOUT -->
  <main class="page-shell">
    <aside class="sidebar" id="indice">
      <h2 id="indice-label">√çndice</h2>
      <div id="dynamic-index"><p>Cargando √≠ndice...</p></div>
    </aside>

    <section class="markdown-body">
      <div id="breadcrumb" class="breadcrumb">Cargando ruta...</div>
      <h1 id="md-title">Cargando‚Ä¶</h1>
      <div id="md-content" style="font-size:.95rem; line-height:1.5;">
        Cargando contenido del apunte‚Ä¶
      </div>

      <div class="nav-buttons">
        <button id="prev-note" title="Anterior">&lt;</button>
        <button id="next-note" title="Siguiente">&gt;</button>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="site-footer-inner">
      <small>¬© <span id="year"></span> xut-e ‚Äî Todos los derechos reservados</small>
      <pre class="ascii" aria-hidden="true">
          ..                      .....          
   .H88x.  :~)88:                 .H8888888h.  ~-.  
  x888888X ~:8888    x.    .      888888888888x  `> 
 ~   "8888X  %88"  .@88k  z88u   X~     `?888888hx~ 
      X8888       ~"8888 ^8888   '      x8.^"*88*"  
   .xxX8888xxxd>    8888  888R    `-:- X8888x       
  :88888888888"     8888  888R         488888>      
  ~   '8888         8888  888R       .. `"88*       
 xx.  X8888:    .   8888 ,888B .   x88888nX"      . 
X888  X88888x.x"   "8888Y 8888"   !"*8888888n..  :  
X88% : '%8888"      `Y"   'YP    '    "*88888888*   
 "*=~    `""                             ^"***"`    
      </pre>
    </div>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>

  <!-- INDEX GENERATOR -->
  <script src="assets/js/generate-index.js"></script>

  <!-- TOGGLE DEL √çNDICE -->
  <script>
  window.addEventListener("load", () => {
    const btn = document.getElementById("toggle-index");
    const aside = document.getElementById("indice");
    const shell = document.querySelector(".page-shell");

    const visible = localStorage.getItem("indexVisible") === "true";

    if (visible) {
      aside.classList.remove("hidden");
      shell.classList.remove("full-width");
      btn.textContent = "Ocultar √≠ndice";
      btn.classList.add("active");
    } else {
      aside.classList.add("hidden");
      shell.classList.add("full-width");
      btn.textContent = "Mostrar √≠ndice";
      btn.classList.remove("active");
    }

    btn.addEventListener("click", e => {
      e.preventDefault();
      const hidden = aside.classList.contains("hidden");

      if (hidden) {
        aside.classList.remove("hidden");
        shell.classList.remove("full-width");
        btn.textContent = "Ocultar √≠ndice";
        btn.classList.add("active");
        localStorage.setItem("indexVisible", "true");
      } else {
        aside.classList.add("collapsing");
        shell.classList.add("full-width");
        btn.textContent = "Mostrar √≠ndice";
        btn.classList.remove("active");
        localStorage.setItem("indexVisible", "false");

        setTimeout(() => {
          aside.classList.remove("collapsing");
          aside.classList.add("hidden");
        }, 300);
      }
    });
  });
  </script>
  <!-- PREPROCESADOR DE LISTAS SEG√öN TU L√ìGICA -->
  <script>
  function fixLists(md) {
    const lines = md.split("\n");
    const out = [];

    let level = 0;                 // nivel actual de lista
    const expected = [1];          // expected[nivel] = siguiente n√∫mero esperado en ese nivel
    let lastWasNumber = false;     // si la l√≠nea anterior era un item numerado
    let inCode = false;            // para no tocar bloques ```...```

    function indent(n) {
      return "    ".repeat(n);
    }

    for (let i = 0; i < lines.length; i++) {
      const originalLine = lines[i];
      const t = originalLine.trim();

      // Detectar bloque de c√≥digo: no tocamos nada dentro
      if (t.startsWith("```")) {
        out.push(originalLine);
        inCode = !inCode;
        lastWasNumber = false;
        continue;
      }
      if (inCode) {
        out.push(originalLine);
        continue;
      }

      // L√≠nea vac√≠a
      if (t === "") {
        out.push("");
        lastWasNumber = false;
        continue;
      }

      const mNum = t.match(/^(\d+)\.\s+(.*)$/);
      const mBullet = t.match(/^[-*+]\s+(.*)$/);

      // -------- LISTA ORDENADA (1. 2. 3. ...) --------
      if (mNum) {
        const num = parseInt(mNum[1], 10);
        const text = mNum[2];

        // Caso normal: coincide con el n√∫mero esperado en este nivel
        if (num === expected[level]) {
          out.push(indent(level) + num + ". " + text);
          expected[level] = num + 1;
          lastWasNumber = true;
          continue;
        }

        // Si esper√°bamos, por ejemplo, 4 y llega un 1 ‚Üí sublista dentro de la actual
        if (num === 1 && expected[level] > 1) {
          level++;
          if (expected[level] == null) expected[level] = 2;
          out.push(indent(level) + "1. " + text);
          lastWasNumber = true;
          continue;
        }

        // Estamos dentro de una sublista y el n√∫mero coincide con el nivel superior:
        // p.ej. nivel 1 esperaba 5, nivel 0 espera 3 y llega un 3 ‚Üí cerramos sublista
        if (level > 0 && num === expected[level - 1]) {
          level--;
          out.push(indent(level) + num + ". " + text);
          expected[level] = num + 1;
          lastWasNumber = true;
          continue;
        }

        // Si nada encaja, reiniciamos como lista de nivel 0 nueva
        level = 0;
        expected[0] = num + 1;
        out.push(num + ". " + text);
        lastWasNumber = true;
        continue;
      }

      // -------- BULLETS (-, *, +) --------
      if (mBullet) {
        const text = mBullet[1];

        // Si venimos de un n√∫mero, lo interpretamos como sub-lista ul dentro del punto
        if (lastWasNumber) {
          out.push(indent(level + 1) + "- " + text);
        } else {
          out.push(indent(level) + "- " + text);
        }
        lastWasNumber = false;
        continue;
      }

      // -------- TEXTO SUELTO --------
      // Si viene justo despu√©s de un n√∫mero, lo consideramos "dentro" del punto
      if (lastWasNumber) {
        out.push(indent(level + 1) + t);
      } else {
        out.push(t);
      }
      lastWasNumber = false;
    }

    return out.join("\n");
  }
  </script>

  <!-- RENDER MARKDOWN -->
  <script>
  (async function () {
    const params = new URLSearchParams(window.location.search);
    const fileParam = params.get("file");

    const titleEl = document.getElementById("md-title");
    const contentEl = document.getElementById("md-content");

    if (!fileParam) {
      titleEl.textContent = "Sin archivo";
      contentEl.textContent = "No se ha especificado ning√∫n archivo.";
      return;
    }

    const realPath = fileParam.startsWith("content/")
      ? fileParam
      : "content/" + fileParam;
    const lower = realPath.toLowerCase();

    if (lower.endsWith(".pdf")) {
      const clean = realPath.split("/").pop().replace(/\.pdf$/i, "");
      titleEl.textContent = clean;
      contentEl.innerHTML = `<iframe src="${realPath}" width="100%" height="80vh"
        style="border:1px solid var(--border-color,#444)"></iframe>`;
      return;
    }

    if (lower.endsWith(".md")) {
      try {
        const res = await fetch(realPath);
        if (!res.ok) throw new Error("No se pudo cargar el archivo");
        let md = await res.text();

        // Normalizar saltos y tabs
        md = md.replace(/\r\n/g, "\n").replace(/\t/g, "    ");

        // T√≠tulo = primer H1 si existe
        const lines = md.split("\n");
        const h1 = lines[0]?.match(/^#\s+(.+)/);
        titleEl.textContent = h1
          ? h1[1].trim()
          : realPath.split("/").pop().replace(/\.md$/i, "");

        // Callouts Obsidian
        md = md.replace(
          /^>\s*\[!(\w+)\](.*?)(?:\n(?!>)([\s\S]*?))?(?=\n{2,}|$)/gm,
          (m, type, title, body = "") => {
            const header = title.trim() || type.toUpperCase();
            const content = body ? body.replace(/^> ?/gm, "") : "";
            return `
<div class="callout callout-${type.toLowerCase()}">
  <div class="callout-title">${header}</div>
  <div class="callout-body">${content.trim()}</div>
</div>`;
          }
        );

        // üî• Aqu√≠ aplicamos la l√≥gica de listas que me pediste
        md = fixLists(md);

        // Parseo con Marked
        let html = marked.parse(md);

        // Im√°genes Obsidian ![[...]] ‚Üí <img ...>
        html = html.replace(/!\[\[(.+?)\]\]/g, (m, file) => {
          const clean = file.trim();
          const src = encodeURIComponent(clean);
          return `<img src="/content/Ciberseguridad/Ciberseguridad/Z%20Imagenes/${src}" alt="${clean}" />`;
        });

        // Enlaces externos en nueva pesta√±a
        html = html.replace(
          /<a href="(https?:\/\/[^"]+)">/g,
          '<a href="$1" target="_blank" rel="noopener">'
        );

        // Insertar HTML final
        contentEl.innerHTML = html;

        // Resaltado de c√≥digo
        contentEl.querySelectorAll("pre code").forEach(block =>
          hljs.highlightElement(block)
        );

      } catch {
        titleEl.textContent = "Error";
        contentEl.textContent = "No se pudo cargar el archivo seleccionado.";
      }
      return;
    }

    titleEl.textContent = realPath.split("/").pop();
    contentEl.innerHTML = `
      <p>No s√© mostrar este tipo de archivo todav√≠a.</p>
      <p><a href="${realPath}" target="_blank" rel="noopener noreferrer">Abrir directamente</a></p>`;
  })();
  </script>
  <!-- BREADCRUMB -->
  <script>
  window.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(window.location.search);
    const file = params.get("file");
    const el = document.getElementById("breadcrumb");

    if (!file) {
      el.textContent = "(Sin ruta)";
      return;
    }

    try {
      const res = await fetch("apuntes/arbol.json");
      if (!res.ok) throw new Error();
      await res.json();

      const parts = file
        .replace(/^content\//i, "")
        .split("/")
        .filter(Boolean)
        .map(s => s.replace(/\.md$/i, "").replace(/-/g, " "))
        .map(s => s.replace(/\b\w/g, c => c.toUpperCase()));

      el.textContent = parts.join(" > ") || "(Sin ruta)";
    } catch {
      el.textContent = "(Error al generar ruta)";
    }
  });
  </script>

  <!-- NAVEGACI√ìN ENTRE NOTAS -->
  <script>
  window.addEventListener("DOMContentLoaded", async () => {
    const btnPrev = document.getElementById("prev-note");
    const btnNext = document.getElementById("next-note");

    const params = new URLSearchParams(location.search);
    const current = params.get("file");
    if (!current) return;

    let tree;
    try {
      const res = await fetch("apuntes/arbol.json");
      tree = await res.json();
    } catch {
      return;
    }

    function flatten(node) {
      let out = [];
      if (Array.isArray(node)) {
        node.forEach(n => out.push(...flatten(n)));
      } else if (node.type === "directory") {
        node.contents?.forEach(n => out.push(...flatten(n)));
      } else if (node.type === "file" && node.path.endsWith(".md")) {
        out.push(node.path);
      }
      return out;
    }

    const allFiles = flatten(tree).sort((a, b) =>
      a.localeCompare(b, undefined, { numeric: true })
    );

    const normalizedCurrent = current
      .replace(/^content\//i, "")
      .replace(/^Ciberseguridad\//i, "");

    const normalizedList = allFiles.map(p =>
      p.replace(/^content\//i, "").replace(/^Ciberseguridad\//i, "")
    );

    const index = normalizedList.indexOf(normalizedCurrent);
    if (index === -1) return;

    const prev = index > 0 ? allFiles[index - 1] : null;
    const next = index < allFiles.length - 1 ? allFiles[index + 1] : null;

    function goTo(path) {
      window.location.href = `markdown-viewer.html?file=${encodeURIComponent(
        path
      )}`;
    }

    if (prev) {
      btnPrev.disabled = false;
      btnPrev.addEventListener("click", () => goTo(prev));
    }

    if (next) {
      btnNext.disabled = false;
      btnNext.addEventListener("click", () => goTo(next));
    }
  });
  </script>

</body>
</html>

