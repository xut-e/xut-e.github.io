---
layout: apunte
title: "5. Dissecting CAPA Results Part 3 - Namespaces"
---

Dividiremos el tema en dos tópicos: Capacidad y Namespace. En esta tarea veremos el **Namespace**.

Debajo podemos ver el output de `capa.exe`:

```powershell
┌──────────────────────────────────────────┬────────────────────────────────────┐
│ Capability                               │ Namespace                          │
├──────────────────────────────────────────┼────────────────────────────────────┤
│ reference anti-VM strings                │ anti-analysis/anti-vm/vm-detection │
│ reference anti-VM strings targeting VMWar│ anti-analysis/anti-vm/vm-detection │
│ reference anti-VM strings targeting Virtu│ anti-analysis/anti-vm/vm-detection │
│ contain obfuscated stackstrings          │ anti-analysis/obfuscation/string/  │
| (2 matches)                              | stackstring                        |
│ reference HTTP User-Agent string         │ communication/http                 │
│ check HTTP status code                   │ communication/http/client          │
│ reference Base64 string                  │ data-manipulation/encoding/base64  │
│ encode data using XOR                    │ data-manipulation/encoding/xor     │
│ contain a thread local storage (.tls)    │ executable/pe/section/tls          │
| section                                  |                                    |
│ get common file path                     │ host-interaction/file-system       │
│ create directory                         │ host-interaction/file-system/create│
│ delete file                              │ host-interaction/file-system/delete│
│ read file on Windows (4 matches)         │ host-interaction/file-system/read  │
│ write file on Windows (5 matches)        │ host-interaction/file-system/write │
│ get thread local storage value           │ host-interaction/process           │
│ create process on Windows                │ host-interaction/process/create    │
│ allocate or change RWX memory            │ host-interaction/process/inject    │
│ reference cryptocurrency strings         │ impact/cryptocurrency              │
│ link function at runtime on Windows      │ linking/runtime-linking            │
| (5 matches)                              |                                    |
│ parse PE header (4 matches)              │ load-code/pe                       │
│ resolve function by parsing PE exports   | load-code/pe                       │
| (186 matches)                            |                                    |
│ run PowerShell expression                │ load-code/powershell/              │
│ schedule task via at                     │ persistence/scheduled-tasks        │
│ schedule task via schtasks               │ persistence/scheduled-tasks        │
└──────────────────────────────────────────┴────────────────────────────────────┘
```

El contenido de este bloque se representa en el formato de abajo:

| Formato                                                               | Ejemplo                                                       | Explicación                                                                                                                                               |
| --------------------------------------------------------------------- | ------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Capability(Rule Name)**::**TLN(Top-Level Namespace)**/**Namespace** | reference anti-VM strings::Anti-Analysis/anti-vm/vm-detection | **Reference anti-VM strings** = CAPABILITY (NOMBRE DE REGLA)  <br>**Anti-Analysis** = TLN o Top-Level Namespace  <br>**anti-vm/vm-detection** = NAMESPACE |

----------------------------
<h2>Namespaces</h2>
CAPA usa los namespaces para agrupar ítems con el mismo propósito.

| Top-Level Namespace (TLN) | Explanation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| anti-analysis             | contains a set of rules specifically designed to detect behaviours exhibited by malware to evade analysis. These behaviours include obfuscation, packing, and anti-debugging techniques.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| collection                | contains a set of data-related rules that malware may enumerate and collect for exfiltration or other purposes. Think of it as the “data-gathering” aspect of malware behaviour.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| communication             | contains a set of rules that pertain to different communication behaviours demonstrated by malware. This encompasses how malware interacts with networks, including data transmission and reception, command and control communications, and other network-related behaviours.                                                                                                                                                                                                                                                                                                                                                                                                                |
| compiler                  | contains a set of rules and configurations for recognizing specific build environments or compilers employed in generating executables. These namespaces essentially serve as the unique “signature” that identifies the compilation process of a program.                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| data-manipulation         | contains a set of rules that govern the behaviours involved in altering data within executable files. This aspect can be considered the “data transformation” component of malware behaviour, encompassing actions such as String Encryption and Data Encoding.                                                                                                                                                                                                                                                                                                                                                                                                                               |
|                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| executable                | contains a set of rules pertaining to the attributes in executable files. These attributes include PE sections or debug info associated with the executable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| host-interaction          | contains a set of rules related to behaviors involving interactions with the host system. This encompasses how malware interacts with its environment. Specifically, the rules in this namespace may capture behaviors related to reading, writing, or modifying files on disk, including creating, deleting, or modifying files and directories.”                                                                                                                                                                                                                                                                                                                                            |
| impact                    | contains a set of rules related to the potential consequences or effects of a program’s behavior. Think of it as the aspect that focuses on the possible harm that this malware can cause. It may include behaviors related to establishing remote access, data exfiltration, destruction, or modification.”                                                                                                                                                                                                                                                                                                                                                                                  |
| internal                  | Rules contained within the system are not intended for direct use by analysts or for reporting. Instead, these rules are meant for internal purposes within the CAPA tool, serving as the behind-the-scenes aspect of rule development and execution.                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| lib                       | building blocks to create other rules                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| linking                   | contains rules to identify behaviors involving linking or dynamically loading external code or libraries during program execution. This is its primary function and is crucial for the program’s security. Understanding linking behavior is essential for several reasons. Malware often depends on external libraries or components (such as OpenSSL, Zlib, or other third-party libraries) to carry out specific tasks. Detecting these dependencies helps analysts understand the malware’s capabilities. External libraries also introduce an additional attack surface. If a vulnerability exists in a linked library, it can be exploited by the malware or defenders during analysis. |
| load-code                 | contains a set of rules and regulations related to the behaviors associated with dynamically loading or executing code during program execution. This concept can be equated to the “runtime code injection” aspect of malware behavior, which involves unauthorized code introduction during a program’s execution.                                                                                                                                                                                                                                                                                                                                                                          |
| malware-family            | contains a set of rules related to behaviors that are linked to particular malware families or groups. It serves as a way to identify the distinct characteristics or “signatures” associated with known malware families, allowing for more accurate detection and classification of potential threats.                                                                                                                                                                                                                                                                                                                                                                                      |
| nursery                   | this is a staging ground that contains rules for those who are not quite polished                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| persistence               | contains rules related to behaviors associated with maintaining access or persistence within a compromised system. This namespace is essentially focused on understanding how malware can establish and maintain a presence within a compromised environment, allowing it to persist and carry out malicious activities over an extended period.                                                                                                                                                                                                                                                                                                                                              |
| runtime                   | contains a set of rules that seek to identify the language or platform on which the program runs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| targeting                 | contains a set of rules related to behaviors exhibited by programs that interact with ATMs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

Veamos cómo funciona esto mirando la tabla de abajo:

| Top-Level Namespace (TLN) | Namespaces           | Rule YAML File                                                                                                  | Explanation                                                                                                                                                                                                                                                                                                                                                              |
| ------------------------- | -------------------- | --------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Anti-Analysis**         | anti-vm/vm-detection | reference-anti-vm-strings-targeting-virtualbox.yml  <br>  <br>reference-anti-vm-strings-targeting-virtualpc.yml | “anti-vm/vm-detection” namespace contains rules to detect virtual machine (VM) environments. These rules focus on identifying specific strings or patterns commonly used by malware to detect VMs while running. Using these rules, CAPA can identify if malware searches for VMware-specific registry keys, the presence of VMware tools, or other VM-related elements. |
|                           | obfuscation          | obfuscated-with-dotfuscator.yml  <br>  <br>obfuscated-with-smartassembly.yml                                    | Malware often uses obfuscation techniques to make analysis more difficult. These include methods such as String Encryption, Code Obfuscation, Packing, and Anti-Debugging Tricks. The obfuscation namespace addresses these techniques, which conceal or obscure the true purpose of the code.                                                                           |

