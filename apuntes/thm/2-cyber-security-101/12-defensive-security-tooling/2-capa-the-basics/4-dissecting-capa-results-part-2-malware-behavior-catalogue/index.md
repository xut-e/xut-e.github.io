---
layout: apunte
title: "4. Dissecting CAPA Results Part 2 - Malware Behavior Catalogue"
---

En esta tarea cubriremos los siguientes tópicos:

- MBC
- Objective
- Micro-Objective
- MBC Behaviours
- Micro-Behaviour
- Methods

```powershell
┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
│ MBC Objective               │ MBC Behavior                                    │
┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
│ ANTI-BEHAVIORAL ANALYSIS    │ Virtual Machine Detection [B0009]               |
├─────────────────────────────┼───────────────────────────────━─────────────────┤
│ ANTI-STATIC ANALYSIS        │ Executable Code Obfuscation::Argument           |
|                             | Obfuscation [B0032.020]                         |
│                             │ Executable Code Obfuscation::Stack Strings      │
|                             | [B0032.017]                                     |
├─────────────────────────────┼─────────────────────────────────────────────────┤
│ COMMUNICATION               │ HTTP Communication [C0002]                      |
│                             │ HTTP Communication::Read Header [C0002.014]     │
├─────────────────────────────┼─────────────────────────────────────────────────┤
│ DATA                        │ Check String [C0019]                            |
│                             │ Encode Data::Base64 [C0026.001]                 |
│                             │ Encode Data::XOR [C0026.002]                    |
├─────────────────────────────┼─────────────────────────────────────────────────┤
│ DEFENSE EVASION             │ Obfuscated Files or Information::Encoding-      |
|                             | Standard Algorithm [E1027.m02]                  |
├─────────────────────────────┼─────────────────────────────────────────────────┤
│ DISCOVERY                   │ File and Directory Discovery [E1083]            │
├─────────────────────────────┼─────────────────────────────────────────────────┤
│ EXECUTION                   │ Command and Scripting Interpreter [E1059]       │
├─────────────────────────────┼─────────────────────────────────────────────────┤
│ FILE SYSTEM                 │ Create Directory [C0046]                        │
│                             │ Delete File [C0047]                             │
│                             │ Read File [C0051]                               │
│                             │ Writes File [C0052]                             │
├─────────────────────────────┼─────────────────────────────────────────────────┤
│ MEMORY                      │ Allocate Memory [C0007]                         │
├─────────────────────────────┼─────────────────────────────────────────────────┤
│ PROCESS                     │ Create Process [C0017]                          │
┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙
```

Afrontaremos el Catálogo de Comportamiento de Malware (Malware Behavior Catalogue MBC) para entender mejor el bloque de arriba.

---------------------------
<h2>Malware Behavior Catalogue (MBC)</h2>
MBC está diseñado para soportar varios aspectos del análisis de malware, como etiquetación, análisis de similaridad y reporte estandarizado. Sirve como un catálogo de los objetivos y comportamientos del malware. También puede relacionar métodos ATT&CK y registrar comportamientos y funcionalidades de código descubiertas durante el análisis. Es importante recalcar que los nombres de los comportamientos MBC pueden, o no, corresponder con técnicas ATT&CK.

El contenido de MBC se puede representar en dos formatos:

| Formato                                                 | Ejemplo                                                                             | Explicación                                                                                                                                                         |
| ------------------------------------------------------- | ----------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **OBJECTIVE**::**Behavior**::**Method**[**Identifier**] | ANTI-STATIC ANALYSIS::Executable Code Obfuscation::Argument Obfuscation [B0032.020] | **Anti-static Analysis** = OBJETIVO  <br>**Executable Code Obfuscation** = COMPORTAMIENTO  <br>**Argument Obfuscation** = MÉTODO  <br>**BOO32.020** = IDENTIFICADOR |
| **OBJECTIVE**::**Behavior**::[**Identifier**]           | COMMUNICATION::HTTP Communication:: [C0002]                                         | **COMMUNICATION** = OBJETIVO  <br>**HTTP Communication** = COMPORTAMIENTO  <br>**C0002** = IDENTIFICADOR                                                            |

La diferencia entre los dos formatos es que el primer formato contiene detalles adicionales  (método, que también se puede acuñar como sub-técnica).

---------------------------------------
<h2>Objetivo</h2>
El objetivo se basa en las tácticas ATT&CK en el contexto del comportamiento del malware. Además, MBC tiene análisis anti-comportamiento y anti-estático. Estos objetivos están diseñados para el análisis de malware con el caso de uso de "**characterizing malware**". En la tabla de abajo hay una explicación de cada una.

| **Objective**                | **Explanation**                                                                                                                                                      |
| ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Anti-Behavioral Analysis** | El malware intenta evitar la detección obstaculizando el análisis con herramientas como entornos sandbox o depuradores.                                              |
| **Anti-Static Analysis**     | El malware intenta obstruir o añadir complejidad a los análisis estáticos haciendo más difícil para los analistas entender el código.                                |
| **Collection**               | El malware se enfoca en identificar y recopilar información de la máquina o red objetivo.                                                                            |
| **Command and Control**      | El malware suele establecer comunicación mediante métodos como servidores C2, , redes P2P, etc. Esto permite a los atacantes controlar los sistemas comprometidos.   |
| **Credential Access**        | El objetivo principal del malware es robar credenciales, como contraseñas y nombres de usuario.                                                                      |
| **Defense Evasion**          | El malware intenta bypassear y circunvalar los varios sistemas de detección y medidas de seguridad para evitar ser detectado.                                        |
| **Discovery**                | El malware busca recolectar información detallada sobre la configuración y setup del sistema o la red en cuestión (incluyendo software, hardware e infraestructura). |
| **Execution**                | El malware está diseñado para ejecutar comandos o código no autorizados en la máquina de la víctima sin su consentimiento.                                           |
| **Exfiltration**             | Está diseñado para infiltrarse en sistemas o redes y robar y extraer información sensible.                                                                           |
| **Impact**                   | Intenta manipular, modificar o dañar sistemas o información.                                                                                                         |
| **Lateral Movement**         | Busca expandirse a través de la red, pasiva o activamente.                                                                                                           |
| **Persistence**              | Diseñado específicamente con la capacidad de permanecer in detectado y operativo en un sistema durante un periodo extenso de tiempo.                                 |
| **Privilege Escalation**     | Busca infiltrarse en un sistema o red para ganar privilegios elevados                                                                                                |

-----------------------------------
<h2>Micro-Objetivos</h2>
Se asocian con los micro-comportamientos, que se refieren a acciones exhibidas por software potencialmente malicioso que no necesariamente lo es y puede servir para otros objetivos. Sin embargo es importante recalcar que estos comportamientos pueden ser abusados. Es por esto que CAPA puede marcarlos como positivos.

| **Micro-Objectivo** | **Descripción**                                                                                                                       |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| **PROCESS**         | Exhibir comportamientos como, pero no limitados a, crear procesos, configurar contexto de hilos, terminar procesos y comprobar mutex. |
| **MEMORY**          | Exhibir comportamientos como, pero no limitados a, asignar memoria, cambiar protección de memoria y liberar memoria.                  |
| **COMMUNICATION**   | Exhibir comportamientos como, pero no limitados a, tráfico (DNS, FTP, HTTP, ICMP, SMTP).                                              |
| **DATA**            | Exhibir comportamientos como, pero no limitados a, comprobar strings, comprimir, codificar y descodificar información.                |

El output final de CAPA, Objetivo y Micro-Objetivo se muestra sólo debajo de la columna **Objective**.

----------------------------------
<h2>Comportamientos MBC</h2>
La columna MBC Behaviors contiene los comportamientos y micro-comportamientos con o sin sus métodos e identificadores. Puedes ver una lista de todo el contenido MBC [aquí](https://github.com/MBCProject/mbc-markdown/blob/main/mbc_summary.md).

Aquí debajo mostramos la versión comprimida de los comportamientos, micro-comportamientos e identificadores.

| **Objectivo**                         | **Comportamiento**                    | Identificador | Explicación                                                                                                                     |
| ------------------------------------- | ------------------------------------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------- |
| ANTI-BEHAVIORAL ANALYSIS              | **Virtual Machine Detection**         | **B0009**     | El malware comprueba si está corriendo en un entorno virtual. Durante este proceso examina artefactos del usuario y el sistema. |
| ANTI-STATIC ANALYSIS                  | **Executable Code Obfuscation**       | **B0032**     | Código ejecutable ha sido obscurizado para obstaculizar el análisis del código.                                                 |
| EXECUTION                             | **Command and Scripting Interpreter** | **E1059**     | El malware puede explotar intérpretes de comandos y scripts para ejecutar comandos, scripts o binarios.                         |
| DISCOVERY                             | **File and Directory Discovery**      | **E1083**     | El malware tiene la capacidad de buscar archivos específicos enumerando archivos y directorios.                                 |
| ANTI-STATIC ANALYSIS, DEFENSE EVASION | **Obfuscated Files or Information**   | **E1027**     | El malware puede ofuscar archivos encodeando o encriptando.                                                                     |

----------------------------------------
<h2>Micro-Comportamientos</h2>
El término "low-level behaviors" en el análisis de malware se refiere a acciones exhibidas por malware que no son necesariamente maliciosas y pueden servir otros propósitos. Es importante recalcar que no porque un comportamiento esté categorizado como micro-comportamiento es inofensivo.

| Micro-Objetivo | Micro-Comportamiento   | Identificador | Explicación                                                                                                                                             |
| -------------- | ---------------------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| MEMORY         | **Allocate Memory**    | **C0007**     | El malware frecuentemente utiliza asignación de memoria como parte de su estrategia para desempaquetarse y ejecutar actividades maliciosas.             |
| PROCESS        | **Create Process**     | **C0017**     | El malware crea un proceso mediante WMI  shellcode. También puede crear un proceso suspendido (segundo plano).                                          |
| COMMUNICATION  | **HTTP Communication** | **C0002**     | El malware es capaz de iniciar comunicaciones HTTP.                                                                                                     |
| DATA           | **Check String**       | **C0019**     | El malware puede inspeccionar una string para identificar características como contenido ASCII, números de tarjetas de crédito y longitud de la string. |
| DATA           | **Encode Data**        | **C0026**     | El malware tiene la capacidad de encodear información usando Base64 o XOR.                                                                              |
| FILE SYSTEM    | **Create Directory**   | **C0046**     | El malware puede crear un directorio.                                                                                                                   |
| FILE SYSTEM    | **Delete File**        | **C0047**     | El malware tiene la capacidad de borrar un archivo.                                                                                                     |
| FILE SYSTEM    | **Read File**          | **C0051**     | El malware puede leer un archivo.                                                                                                                       |
| FILE SYSTEM    | **Writes File**        | **C0052**     | El malware tiene la capacidad de escribir un archivo.                                                                                                   |

EL output final de CAPA, Comportamiento y Micro-Comportamiento se muestran sólo debajo de la columna **Behavior**.

-------------------------------
<h2>Métodos</h2>
Por último, miraremos los Métodos. Debajo están algunos de los métodos incluidos en los resultados del ejemplo anterior. Los métodos están relacionados con los comportamientos.

| Comportamiento                  | Método o sub-técnica            | Identificador | Explicación                                                                                                         |
| ------------------------------- | ------------------------------- | ------------- | ------------------------------------------------------------------------------------------------------------------- |
| Executable Code Obfuscation     | **Argument Obfuscation**        | B0032.020     | Números simples o argumentos de string se calculan en el momento de la ejecución, haciendo más difícil el análisis. |
| Executable Code Obfuscation     | **Stack Strings**               | B0032.017     | Construir y descifrar strings en el stack en cada uso y después descartarlas para evitar futuras referencias        |
| HTTP Communication              | **Read Header**                 | C0002.014     | Header de lectura HTTP.                                                                                             |
| Encode Data                     | **Base64**                      | C0026.001     | El malware podría codificar información en Base64.                                                                  |
| Encode Data                     | **XOR**                         | C0026.002     | El malware podría usar XOR para codificar la información.                                                           |
| Obfuscated Files or Information | **Encoding-Standard Algorithm** | E1027.m02     | Codificar pruebas de malware, archivos u otra información usa un algoritmo estándar (ej: Base64).                   |

Ahora que tenemos una vista y entendimiento amplios de los contenidos MBC, deberíamos ser capaces de explicar el resultado del ejemplo anterior. Vamos a hacer un repaso usando uno de los resultados:

```powershell
┌─────────────────────────────┬──────────────────────────────────┐
│ MBC Objective               │ MBC Behavior                     │
├─────────────────────────────┼──────────────────────────────────┤
| DATA                        │ Encode Data::Base64 [C0026.001]  │
└─────────────────────────────┴──────────────────────────────────┘
```

| Etiqueta      | Valor           | Explicación                                                                                                            |
| ------------- | --------------- | ---------------------------------------------------------------------------------------------------------------------- |
| MBC Objective | **DATA**        | Exhibir comportamientos como, pero no limitados a, comprobar strings, comprimir, codificar y descodificar información. |
| MBC Behavior  | **Encode Data** | Tiene la habilidad para codificar información usando Base64 y XOR.                                                     |
| Method        | **Base64**      | El malware podría encodear información usando Base64.                                                                  |
| Identifier    | **C0026.001**   | Da información sobre el comportamiento. También sirve como etiqueta.                                                   |
Sabiendo estas información puedes decir que el archivo puede usar un esquema de codificación Base64.

