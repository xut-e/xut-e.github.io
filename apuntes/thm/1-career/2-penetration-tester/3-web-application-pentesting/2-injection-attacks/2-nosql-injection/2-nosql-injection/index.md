---
layout: apunte
title: "2. NoSQL Injection"
---

<h2>Injection is Injection</h2>
Mientras que parece complejo pensar en una inyección NoSQL, cuando reducimos los ataques de inyección a su esencia, podemos entender las similitudes entre las inyecciones SQL y NoSQL.

La causa raíz de un ataque de inyección es la concatenación indebida o input del usuario no confiable en un comando que puede permitir al atacante alterar el propio comando. Con la inyección SQL el acercamiento más común es inyectar comillas simples o dobles. El mismo principio aplica a la inyección NoSQL. Si se añade a la query un input no confiable, tenemos la oportunidad de modificar la propia query. Hay dos tipos principales de inyección NoSQL:

- **Inyección de Sintaxis:** Es similar a la inyección SQL, donde tenemos la habilidad de romper la query e inyectar nuestro propio payload. La diferencia principal es la sintaxis usada.
- **Inyección de Operadores:** Incluso si no podemos romper la query, potencialmente podemos inyectar operadores query NoSQL que manipulen el comportamiento de la query permitiéndonos realizar ataques como bypasses de autentificación.

En esta unidad nuestro foco principal estará centrado en la inyección de operadores y las diferentes maneras en las que puede ser usado. Eso es porque no es tan común encontrar casos de inyección de sintaxis. Sin embargo, ya que el input del usuario puede variar, estos mismos filtros pueden ser vulnerables a la inyección de operadores. Sin embargo, cubriremos un ejemplo de inyección de sintaxis al final de la unidad.

------------------------------------------
<h2>¿Cómo Inyectar NoSQL?</h2>
Al mirar a cómo los filtros NoSQL son construidos, bypassearlos para inyectar cualquier payload puede parecer imposible, ya que recaen en crear un array estructurado. Al contrario que la SQLi, donde las queries normalmente se construyen con simple concatenación de comandos, las queries NoSQL requieren arrays asociativos anidados. Esto significa que para inyectar NoSQL, uno debe poder inyectar arrays en la aplicación.

Por suerte para nosotros, muchos lenguajes de programación del lado del servidor nos permiten pasar arrays usando una sintaxis especial en la string query de una petición HTTP. Para el propósito de este ejemplo nos centraremos en el siguiente código escrito en PHP para una simple página de login:

```php
<?php
$con = new MongoDB\Driver\Manager("mongodb://localhost:27017");


if(isset($_POST) && isset($_POST['user']) && isset($_POST['pass'])){
        $user = $_POST['user'];
        $pass = $_POST['pass'];

        $q = new MongoDB\Driver\Query(['username'=>$user, 'password'=>$pass]);
        $record = $con->executeQuery('myapp.login', $q );
        $record = iterator_to_array($record);

        if(sizeof($record)>0){
                $usr = $record[0];

                session_start();
                $_SESSION['loggedin'] = true;
                $_SESSION['uid'] = $usr->username;

                header('Location: /sekr3tPl4ce.php');
                die();
        }
}
header('Location: /?err=1');

?>
```

La aplicación web está haciendo una petición a MongoDB usando la base de datos `myapp` y la colección `login`, pidiendo cualquier documento que pase el filtro `['username'=>$user, 'password'=>$pass]`, donde ambos, `$user` y `$pass` se obtienen directamente de parámetros HTTP POST. Echemos un vistazo a cómo podemos usar la inyección de operadores para bypassear la autentificación.

Si por lo que sea podemos mandar un array a `$user` y `$pass` con el siguiente contenido:

`$user = ['$ne'=>'xxxx']`
`$pass = ['$ne'=>'yyyy']`

Podríamos engañar a la base de datos para que nos devuelva todos los documentos donde el usuario sea distinto de `xxxx` y la contraseña distinta de `yyyy`. Esto devolvería todos los documentos en la colección login. Como resultado, la aplicación detectaría un inicio de sesión exitoso y nos daría los privilegios del usuario al que corresponda el primer documento obtenido.

El problema es que no sabemos cómo pasar un array como parte de la petición HTTP POST. Resulta que PHP y varias otras lenguas permiten pasar un array usando la siguiente notación en el cuerpo de la petición POST.

`user[$ne]=xxxx&pass[$ne]=yyyy`

