---
layout: apunte
title: "3. How ORM Works"
---

<h2>Mapear Entre Objetos en el Código y Tablas de Bases de Datos</h2>
ORM es una técnica que simplifica la interacción de información en una aplicación mapeando objetos en el código a tablas de bases de datos. En PHP, este proceso involucra definir clases que representen tablas de bases de datos y sus relaciones, Cada clase corresponde a una columna en la tabla, y cada instancia de clase representa una fila.

Por ejemplo, usando Laravel's Eloquent ORM, puedes definir una clase modelo así:

```php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;
class User extends Model
{
    protected $table = 'users';
    protected $fillable = [
        'name', 'email', 'password',
    ];
    // Other Eloquent model configurations can go here...
}
```

En este ejemplo, la clase `User` se mapea a la tabla `user` en la base de datos, con propiedades correspondiendo a las columnas. Eloquent ORM maneja la traducción entre estas representaciones de objetos y las queries SQL subyacentes, permitiendo a los desarrolladores manipular registros de bases de datos usando sintaxis orientada a objetos.

----------------------------------------
<h2>Operaciones ORM Comunes (Create, Read, Update, Delete)</h2>
Las operaciones comunes de bases de datos en frameworks ORM, comúnmente conocidas como CRUD:

- **Create:** Crear nuevos registros en la base de datos involucra instanciar un nuevo objeto modelo, configurando sus propiedades y guardándolo en la base da datos.
  
```php
use App\Models\User;

// Create a new user
$user = new User();
$user->name = 'Admin';
$user->email = 'admin@example.com';
$user->password = bcrypt('password'); 
$user->save();
```
  
  Este código crea un nuevo usuario y lo guarda en la base de datos. El método de guardado prepara la entidad para su inserción y ejecuta el statement SQL INSERT para añadir un nuevo registro en la tabla users. La función `bcrypt()` es usada para hashear de forma segura la contraseña antes de guardarla.
- **Read:** Leer los registros de la base de datos involucra recuperar información usando varios métodos de Eloquent.
  
```php
use App\Models\User;

// Find a user by ID
$user = User::find(1);

// Find all users
$allUsers = User::all();

// Find users by specific criteria
$admins = User::where('email', 'admin@example.com')->get();
```
  
  Este código demuestra formas diferentes de recuperar registros de la base de datos. La función `find(1)` recupera el usuario con ID 1 ejecutando el statement SQL SELECT. La función `all()` recupera todos los usuarios ejecutando `SELECT * FROM users`. La cláusula `where('email', 'admin@example.com')->get()` recupera los usuarios con el email especificado ejecutando `SELECT * FROM users WHERE emai = 'admin@example.com'`.

De forma similar a las operaciones create y read, las funcionalidades delete y update siguen un enfoque similar. Para actualizaciones recuperas el registro existente, lo modificas y guardas los cambios. Para borrados recuperas el registro y llamas al método delete para eliminarlo de la base de datos. 

------------------------------------------------
<h2>Comparando la Inyección SQL y ORM</h2>
La inyección SQL y ORM son ambas técnicas usada para explotar vulnerabilidades en las interacciones de las bases de datos, pero tienen como objetivos diferentes niveles del stack:

- **SQL Injection:** Apunta a queries SQL, permitiendo a los atacantes manipular statements SQL directamente. Esto se consigue inyectando input malicioso en la string query. La parte de inyección en la siguiente query, `OR '1'='1`, siempre evalúa en true.

```php
SELECT * FROM users WHERE username = 'admin' OR '1'='1';
```

- **ORM Injection:** Apunta al framework ORM explotando cómo se construyen las queries desde las operaciones de objetos. Los atacantes manipulan los métodos ORM y propiedades para influenciar las queries SQL resultantes.
  
 ```php
 $userRepository->findBy(['username' => "admin' OR '1'='1"]);
 ```
  
  En el código de arriba, la parte de la inyección, `admin' OR '1'='1`, siempre se evalúa en true.

------------------------------------------
<h2>Diferencias Clave en Técnicas de Explotación</h2>

| **Aspecto**        | **SQL Injection  <br>**                                                   | **ORM Injection**                                                                                                              |
| ------------------ | ------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| Nivel de Inyección | Apunta a queries SQL raw directamente                                     | Apunta a la construcción de queries del framework ORM                                                                          |
| Complejidad        | Más directo ya que manipula SQL                                           | Requiere entendimiento de cómo funcionan los métodos internos de ORM                                                           |
| Detección          | Más fácil de detectar con WAFs tradicionales y registros query            | Más difícil detectar ya que los payloads están en métodos ORM                                                                  |
| Mitigación         | Uso de statements preparados, queries parametrizadas, validación de input | Configuración ORM correcta, validación de input a nivel de aplicación, funcionalidades ORM reforzando la seguridad de la query |

----------------------------------------------
<h2>Configurando el Entorno</h2>
Ya que estamos usando Laravel para este proyecto, explicaremos brevemente cómo configurar Eloquent ORM (Laravel-Based). Eloquent ORM es el ORM por defecto de Laravel, que ofrece una implementación de `Active Record` simple y bonita para trabajar con tu base de datos. Primero, debemos instalar Laravel usando Composer. Abre tu terminal y ejecuta el comando `composer create-project --prefer-dist laravel/laravel thm-project`, donde `thm-project` es el nombre del proyecto. No necesitas hacer estos pasos, es sólo para ayudarte a entender cómo funciona.

<h4>Configurar las Credenciales de la Base de Datos</h4>
Después necesitamos configurar nuestras credenciales. Laravel usa el archivo `.env` para almacenar las variables de entorno, incluyendo credenciales. Abre el archivo `.env` en la raíz de tu proyecto Laravel y actualiza las siguientes líneas con los detalles de tu base de datos.

```php
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=your_database_name
DB_USERNAME=your_database_user
DB_PASSWORD=your_database_password
```

<h4>Configurar Migraciones</h4>
Las migraciones son el control de versiones de tu base de datos, permitiéndote modificar y compartir fácilmente el esquema de la base de datos. El sistema de migración de Laravel es una parte esencial del framework y simplifica el manejo de los cambios en la base de datos.

<h4>Crear una Migración</h4>
Para crear una migración, podemos usar el comando `Artisan` que viene con Laravel. Puedes ejecutar el comando `php artisan make:migration create_users_table --create=users` para generar una migración para la tabla `users`.

Este comando genera un archivo de migración en el directorio de base de datos/migración. El archivo de migración contiene métodos para definir la estructura de la tabla `users`.

```php
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
class CreateUsersTable extends Migration
{
    public function up()
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->string('password');
            $table->timestamps();
        });
    }
    public function down()
    {
        Schema::dropIfExists('users');
    }
}
```

En el código de arriba, el método `up()` define la estructura de la tabla `users`. Por el contrario, `down()` dropea la tabla `users` si se revierte la migración.

Después de definir la migración, ejecuta el comando `php artisan migrate` para aplicar la migración y crear la tabla `users` en la base de datos. Este comando ejecutará `up()` en el archivo de migración y creará la tabla `users` con las columnas especificadas en la base de datos.

En el contexto de ORM, las migraciones simplifican el proceso de mapear las tablas de la base de datos para modelos de aplicación. Sin embargo, desde el punto de vista de un red teamer, migraciones mal configuradas pueden llevar a vulnerabilidades como ORM injection.